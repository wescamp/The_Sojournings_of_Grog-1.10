#textdomain wesnoth-The_Sojournings_of_Grog

#
# TODO: make the teleport also shroud the caves again
# TODO: scroll to units after teleport before door shut
#
# wmllint: recognize bodyguard_1
# wmllint: recognize bodyguard_2
# wmllint: recognize bodyguard_3
# wmllint: recognize bodyguard_4
# wmllint: recognize bodyguard_5
# wmllint: recognize Grog
# wmllint: recognize killer_bodyguard_1
# wmllint: recognize killer_bodyguard_2
# wmllint: recognize killer_bodyguard_3
# wmllint: recognize killer_bodyguard_4
# wmllint: recognize killer_bodyguard_5

[scenario]
    id=A3
    next_scenario=A4

    name=_"First Contact"
    map_data="{~add-ons/The_Sojournings_of_Grog/maps/A3-First_Contact.map}"

    victory_when_enemies_defeated=no

    {TURNS 30 25 20}

    {UNDERGROUND}

    {INTRO_AND_SCENARIO_MUSIC "underground.ogg" "vengeful.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "northerners.ogg"}

    [story]
        [part]
            story= _ "They were brought down to meet the Undead master; Elyssa hoped that he would be a mere necromancer. She had met the Undead before, unlike the trolls and she had no delusions about their fate. Since their victory against the Dwarves they had practically been prisoners. Grog gave orders for the Trolls to prepare for a possible attack; Elyssa was not sure it would be enough. As they entered the Undead realm Elyssa wondered if she could create enough fire."
            background=portraits/undead/transparent/lich.png
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        team_name=goodies
        user_team_name=_"Goodies"

        {GROG}
        type="Grog Great"

        shroud=yes
        fog=yes

        {GOLD 100 100 100}
        {INCOME 4 2 0}

        {TROLL_FLAG}
    [/side]

    [side]
        type=Ancient Lich
        id=U
        name="Mal-Apophis"

        canrecruit=yes
        # removed Wraith from recruit list. No replacement on Easy, Ghosts in Medium, add back in Hard. E_H.
#ifdef EASY
        recruit=Deathblade,Chocobone,Bone Knight
#endif
#ifdef NORMAL
        recruit=Deathblade,Chocobone,Bone Knight,Ghost
#endif
#ifdef HARD
        recruit=Deathblade,Chocobone,Bone Knight,Wraith
#endif
        side=2
        team_name=Undead
        user_team_name= _ "Undead Forces"
        shroud=no
        fog=no

        {GOLD 100 150 200}
        {INCOME 30 40 50}

        [ai]
            passive_leader=yes
            aggression=1.0
            caution=0.0
            recruitment_ignore_bad_movement="yes"
            recruitment_ignore_bad_combat="yes"
            simple_targeting="yes"
            village_value=0
            villages_per_scout=0
            attack_depth=6
            #a yeti pack is inbeatable
            grouping=no
            [target]
                side=1
                value=600
            [/target]
        [/ai]

        {FLAG_VARIANT undead}

        #give us a chance
        #{ATTACK_DEPTH 2 2 2}

        {GENERIC_UNIT 2 (Revenant) 34 12}
        {GENERIC_UNIT 2 (Chocobone) 39 15}
        {GENERIC_UNIT 2 (Deathblade) 34 4}
        {GENERIC_UNIT 2 (Revenant) 46 11}
        {GENERIC_UNIT 2 (Chocobone) 41 1}
        {GENERIC_UNIT 2 (Deathblade) 46 3}
        {GENERIC_UNIT 2 (Deathblade) 39 11}
        {GENERIC_UNIT 2 (Revenant) 41 11}
        {GENERIC_UNIT 2 (Chocobone) 39 5}
        {GENERIC_UNIT 2 (Deathblade) 41 5}
        {GENERIC_UNIT 2 (Chocobone) 34 11}
        {GENERIC_UNIT 2 (Bone Shooter) 40 14}
        {GENERIC_UNIT 2 (Chocobone) 40 1}
        {GENERIC_UNIT 2 (Bone Shooter) 46 4}
        {GENERIC_UNIT 2 (Bone Knight) 40 12}
        {GENERIC_UNIT 2 (Bone Knight) 40 3}
        {GENERIC_UNIT 2 (Deathblade) 43 6}
#ifdef HARD
        {GENERIC_UNIT 2 (Wraith) 37 10}
        {GENERIC_UNIT 2 (Wraith) 37 6}
        {GENERIC_UNIT 2 (Wraith) 43 10}
#else
        {GENERIC_UNIT 2 (Ghost) 37 10}
        {GENERIC_UNIT 2 (Ghost) 37 6}
        {GENERIC_UNIT 2 (Ghost) 43 10}
#endif
        #surrounding guards. Deathblade on medium due to +1 strikes and +1 MP. E_H.
#ifdef EASY
        {GENERIC_UNIT 2 (Revenant) 27 15}
        {GENERIC_UNIT 2 (Revenant) 31 19}
        {GENERIC_UNIT 2 (Revenant) 32 13}
        {GENERIC_UNIT 2 (Revenant) 34 15}
        {GENERIC_UNIT 2 (Revenant) 27 19}
#endif
#ifdef NORMAL
        {GENERIC_UNIT 2 (Deathblade) 27 15}
        {GENERIC_UNIT 2 (Deathblade) 31 19}
        {GENERIC_UNIT 2 (Deathblade) 32 13}
        {GENERIC_UNIT 2 (Deathblade) 34 15}
        {GENERIC_UNIT 2 (Deathblade) 27 19}
#endif
#ifdef HARD
        {GENERIC_UNIT 2 (Draug) 27 15}
        {GENERIC_UNIT 2 (Draug) 31 19}
        {GENERIC_UNIT 2 (Draug) 32 13}
        {GENERIC_UNIT 2 (Draug) 34 15}
        {GENERIC_UNIT 2 (Draug) 27 19}
#endif
    [/side]

    #In case of supreme luck
    #{FORCE_CHANCE_TO_HIT (side=1) (id=U) 0 ()}
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=U
        [/filter]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Mal-Apophis quaffs an healing potion!"
            sound=potion.ogg
        [/message]

        {FULL_HEAL id=U}

        [sound]
            name=heal.wav
        [/sound]

        [redraw]
        [/redraw]
    [/event]

    [side]
        type=Armageddon Drake
        id=S
        name="Drake Ambassador"

        canrecruit=yes
        recruit=Drake Burner,Sky Drake
        side=3
        team_name=Undead
        user_team_name= _ "Drake's Forces"
        shroud=no

        {GOLD 100 150 200}
        {INCOME 30 40 50}

        [ai]
            passive_leader=yes
            aggression=1.0
            caution=0.0
            recruitment_ignore_bad_movement="yes"
            recruitment_ignore_bad_combat="yes"
            simple_targeting="yes"
            village_value=0
            villages_per_scout=0
            attack_depth=6
            #a yeti pack is inbeatable
            grouping=no
            [target]
                side=1
                value=600
            [/target]
        [/ai]

        {FLAG_VARIANT drake}

        #created here to give him a look in on the recruiting clever (Eros)
        {GENERIC_UNIT 3 (Sky Drake) 40 7}
        {GENERIC_UNIT 3 (Sky Drake) 39 7}
        {GENERIC_UNIT 3 (Sky Drake) 41 7}
    [/side]

    #In case of supreme luck
    #{FORCE_CHANCE_TO_HIT (side=1) (id=S) 0 ()}
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=S
        [/filter]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "The Drake Ambassador quaffs an healing potion!"
            sound=potion.ogg
        [/message]

        {FULL_HEAL id=S}

        [sound]
            name=heal.wav
        [/sound]

        [redraw]
        [/redraw]
    [/event]

    [side]
#ifdef EASY
        type=Death Baron
#else
        type=Death Knight
#endif
        id=L
        name= _ "Lotin"
        canrecruit=yes
#ifdef EASY
        recruit=Skeleton,Skeleton Archer
#endif
#ifdef NORMAL
        recruit=Skeleton,Skeleton Archer,Ghost
#endif
#ifdef HARD
        recruit=Skeleton,Skeleton Archer,Ghost,Chocobone
#endif
        side=4
        team_name=Undead
        user_team_name= _ "Gate Guard"
        shroud=no
        {GOLD 80 120 160}

        [ai]
            # who knows why, but on 1.9.3 recruitment_pattern is recognized by the inspect window,
            # and seems to be ignored by the engine. I got 3 Chocobones and 3 Skeletons on Hard. File a bug report? E_H.
#ifdef EASY
            recruitment_pattern=fighter,fighter,archer,archer
#else
            recruitment_pattern=fighter,fighter,archer,archer,scout
#endif
        [/ai]

        {FLAG_VARIANT undead}
    [/side]

#ifdef HARD
    [event]
        name=prestart
        [terrain]
            x=25,28,23,24,22,28,26,26,19,27,11,14,12,12,9
            y=21,17,27,21,29,20,19,24,28,20,34,34,35,32,36
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

#ifdef NORMAL
    [event]
        name=prestart
        [terrain]
            x=25,25,28,23,24,22,28,26,26,19,27,11,14,12,12,9,24,21,24,23,14,10,8
            y=20,21,17,27,21,29,20,19,24,28,20,34,34,35,32,36,25,29,26,23,32,26,32
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

#ifdef EASY
    [event]
        name=prestart
        [terrain]
            x=25,25,28,23,24,22,28,26,26,19,27,11,14,12,12,9,24,21,24,23,14,10,8,15,17,28,22,25
            y=20,21,17,27,21,29,20,19,24,28,20,34,34,35,32,36,25,29,26,23,32,26,32,31,34,21,28,25
            terrain=Uu^Ii
        [/terrain]
        [redraw][/redraw]
    [/event]
#endif

    [time_area]
        # runes are placed at 14,31 and 17,33
        x=   13,   14,   15,   16,   17,   18
        y=31-32,30-32,31-32,32-33,32-34,32-33
        {RUNIC}
    [/time_area]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Escape the Lich"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Grog"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Elyssa"
                condition=lose
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        [remove_shroud]
            side=1
            x,y=9,65
            radius=10
        [/remove_shroud]
    [/event]

    [event]
        name=start
        #disallow recruitment
        [disallow_recruit]
            side=1
            type=Troll Whelp
        [/disallow_recruit]

        #Failsafe lines, just in case that the player doesn't have enough units available for recall.
        #Bug reported by ydcl, bugfix suggested by Anonymissimus. Thank you both. Elvish_Hunter
        [if]
            [not]
                [have_unit]
                    type=Troll Warrior,Troll Boulderlobber,Troll,Troll Rocklobber,Troll Whelp
                    count=5-99999
                    search_recall_list=yes
                [/have_unit]
            [/not]
            [then]
                # wmlscope: start ignoring
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                {GENERIC_UNIT 1 (Troll Whelp) recall recall}
                # wmlscope: stop ignoring
            [/then]
        [/if]

        #[if]
        #    [not]
        #        [have_unit]
        #            race=elf
        #            search_recall_list=yes
        #        [/have_unit]
        #    [/not]
        #    [then]
        #        # wmlscope: start ignoring
        #        {GENERIC_UNIT 1 (Desert Hunter) recall recall}
        #        # wmlscope: stop ignoring
        #    [/then]
        #[/if]

        {ROLEMACRO 1 "Troll Warrior,Troll Boulderlobber,Troll,Troll Rocklobber,Troll Whelp"}
        {ROLEMACRO 2 "Troll,Troll Rocklobber,Troll Warrior,Troll Boulderlobber,Troll Whelp"}
        {ROLEMACRO 3 "Troll Boulderlobber,Troll Warrior,Troll Rocklobber,Troll,Troll Whelp"}
        {ROLEMACRO 4 "Troll Rocklobber,Troll,Troll Boulderlobber,Troll Warrior,Troll Whelp"}
        #{ROLEMACRO 5 "Desert Star,Desert Prowler,Desert Shyde,Desert Sharpshooter,Desert Avenger,Desert Sentinel,Desert Marksman,Desert Ranger,Desert Marshal,Desert Champion,Desert Captain,Desert Hero,Desert Hunter,Desert Druid,Desert Archer,Desert Fighter,Desert Shaman"}
        {ROLEMACRO 5 "Troll Whelp,Troll Rocklobber,Troll,Troll Boulderlobber,Troll Warrior"}

        {VARIABLE temp1.id "bodyguard_1"}
        {VARIABLE temp2.id "bodyguard_2"}
        {VARIABLE temp3.id "bodyguard_3"}
        {VARIABLE temp4.id "bodyguard_4"}
        {VARIABLE temp5.id "bodyguard_5"}

        #Initialising these variables here. We will use them to keep track of who killed who. E_H.
        {VARIABLE bodyguard_1_killed_by none}
        {VARIABLE bodyguard_2_killed_by none}
        {VARIABLE bodyguard_3_killed_by none}
        {VARIABLE bodyguard_4_killed_by none}
        {VARIABLE bodyguard_5_killed_by none}

        {RECALLMACRO 1}
        {RECALLMACRO 2}
        {RECALLMACRO 3}
        {RECALLMACRO 4}
        {RECALLMACRO 5}

        [recall]
            id=Elyssa
            x,y=31,16
        [/recall]

        #clear the recall list
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=Grog_recall_list
            kill=yes
        [/store_unit]

        #initialising a variable to check if the bridge was already destroyed, to fix a bug reported by Daravel. E_H.
        [set_variable]
            name=bridge_destroyed
            value=no
        [/set_variable]

        [scroll_to]
            x,y=36,11
        [/scroll_to]

        {CLEAR_FOG 1 40 8 10}

        [message]
            speaker=Elyssa
            #change not just a paltry necromancer but a full blown lich
            message= _ "A Lich! I still remember when Garak turned to the dark magics. We are in trouble."
        [/message]

        #[message]
        #    speaker=Elyssa
        #	message= _ "I don't like this; a Lich is bad news."
        #[/message]

        #bold to put emphasis on what the lich thinks about himself. E_H..
        [message]
            speaker=U
            message=_ "A Lich? Do you think I am some kind of rotting corpse? <b>I am Mal-Apophis! The lich... The ancient Lich!</b> I have defied the kingdoms of life and death since the former years and you dare call me <i>a mere Lich?</i>"
        [/message]

        [message]
            speaker=U
            message=_ "Your ignorance is pardonable. It is inconceivable that you could imagine such a being as <b>me!</b>"
        [/message]

        [message]
            speaker=U
            message=_ "Let me present the ambassador of my newest ally."
        [/message]

        [message]
            speaker=Elyssa
            message=_ "A Drake! I have greatly wished to see one..."
        [/message]

        [message]
            speaker=S
            message=_ "BREAAAKFAAAST!" # wmllint: no spellcheck
        [/message]

        [message]
            #TODO have a elf role macro here
            speaker=Grog
            message=_ "Perhaps not this close!"
        [/message]

        [message]
            speaker=U
            message=_ "As thanks for your endeavors in my service, I will resurrect you as my principal servants!"
        [/message]

        [message]
            speaker=Grog
            message=_ "Grog dun like hissing thing. Grog want smash it."
        [/message]

        [message]
            speaker=Elyssa
            # wmllint: local spelling un-brain
            message=_ "Slaves! Not before I fry your delusional un-brain!"
        [/message]

        #[message]
        #    speaker=bodyguard_1
        #	message=_ "Ha! Good one."
        #[/message]

        # [flash_screen] is a custom Lua tag. E_H.
        [flash_screen]
            color=white
        [/flash_screen]
        {REPEAT 2 (
            {QUAKE "fire.wav"}
            [flash_screen]
                color=black
            [/flash_screen]
            {RANDOM (dragonstick.ogg,lightning.ogg,magic-faeriefire.ogg)}
            {QUAKE $random}
            {CLEAR_VARIABLE random}
            {RANDOM (lich-hit-1.ogg,lich-hit-2.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            {RANDOM (skeleton-big-hit-1.ogg,skeleton-big-hit-2.ogg,skeleton-big-hit-3.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            [flash_screen]
                color=blue
            [/flash_screen]
        )}

        #reduce enemy hp
        #cant use modify unit. shame! (EROS)
        # don't worry Eros, I know Lua and I'll use it.
        # It does exactly the same thing as the old WML structure, and also floats the damage label. E_H.
        [lua]
            code=<<
			--[[local units_to_damage = wesnoth.get_units { race = "undead", { "or", { race = "drake" } }, { "not", { id = "L" } } }
			for index, unit in ipairs ( units_to_damage ) do
				if unit.valid then
					unit.hitpoints = math.floor ( unit.hitpoints * 0.75 )
					wesnoth.float_label ( unit.x, unit.y, string.format( "<span color='red'>%d</span>", unit.max_hitpoints - unit.hitpoints ) )
				end
			end]]
		>>
        [/lua]
        [harm_unit]
            [filter]
                race=undead
                [or]
                    race=drake
                [/or]
            [/filter]
            amount="$($this_unit.hitpoints*0.25)"
            animate=no
            kill=no
            fire_event=no
        [/harm_unit]

        [message]
            speaker=U
            message=_ "AAAAAHHHHH! Guards! Kill them all." # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elyssa
            message=_ "I don't think so. Melt in the hot suns Lich!"
        [/message]

        [flash_screen]
            color=white
        [/flash_screen]
        {REPEAT 3 (
            {QUAKE "fire.wav"}
            [flash_screen]
                color=yellow # like the sun.
            [/flash_screen]
            {RANDOM (dragonstick.ogg,lightning.ogg,magic-faeriefire.ogg)}
            {QUAKE $random}
            {CLEAR_VARIABLE random}
            {RANDOM (lich-hit-1.ogg,lich-hit-2.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            {RANDOM (skeleton-big-hit-1.ogg,skeleton-big-hit-2.ogg,skeleton-big-hit-3.ogg)}
            [sound]
                name=$random
            [/sound]
            {CLEAR_VARIABLE random}
            [flash_screen]
                color=cyan
            [/flash_screen]
        )}

        #reduce enemy hp
        #cant use modify unit. shame! (EROS)
        # ditto as above. E_H.

        [lua]
            code=<<
			--[[local units_to_damage = wesnoth.get_units { race = "undead", { "or", { race = "drake" } }, { "not", { id = "L" } } }
			for index, unit in ipairs ( units_to_damage ) do
				if unit.valid then
					local hp_before_attack = unit.hitpoints
					unit.hitpoints = math.floor ( unit.hitpoints * 0.67 )
					wesnoth.float_label ( unit.x, unit.y, string.format( "<span color='red'>%d</span>", hp_before_attack - unit.hitpoints ) )
				end
			end]]
		>>
        [/lua]
        [harm_unit]
            [filter]
                race=undead
                [or]
                    race=drake
                [/or]
            [/filter]
            amount="$($this_unit.hitpoints*0.33)"
            animate=no
            kill=no
            fire_event=no
        [/harm_unit]

        [message]
            speaker=Elyssa
            message=_ "Well, that was the best I could manage. Your move, Grog."
        [/message]

        [message]
            speaker=Grog
            message=_ "Grog say run!"
        [/message]

        # and this is per Anonymissimus' suggestion.
        [message]
            speaker=Elyssa
            message=_ "This cave is full of side tunnels. Let's try to stay on the main road, for we don't know how much the other tunnels will slow us down."
        [/message]

        [message]
            speaker=S
            message=_ "RRRRRRAAAAAAAUUUUUURRRGGHHHHH!" # wmllint: no spellcheck
        [/message]

        #	[message]
        #		speaker=narrator
        #		message= _ "You glimpse a vague outline of a door to the south.  From the east and west strange blue lights are emanating."
        #		image=wesnoth-icon.png
        #	[/message]

        {UNCLEAR_FOG}
    [/event]

    # we will make things more interesting by giving the units more xp
    # mod from utbs (Eros)
    # replaced with a Lua code. E_H.
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=2,3,4
        [/filter]

        [lua]
            code=<<
			local t = ...
			local unit = wesnoth.get_units( { id = t.id } )[1]
			local min = math.floor( unit.max_experience * 0.5 )
			local max = math.ceil( unit.max_experience * 0.9 )
			
			local function sync()
				return { amount = math.random( min, max ) }
			end
			
			local result = wesnoth.synchronize_choice(sync)
			unit.experience = result.amount
		>>
            [args]
                id=$unit.id
            [/args]
        [/lua]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                #was 20,29
                x,y=16,31
                radius=4
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Elyssa
            [/variable]
            [then]
                [message]
                    speaker=Elyssa
                    # wmllint: local spelling er un-kill
                    message=_ "Dwarven runes! Have a look and see what they do. I need to save my magic for the Lich; hes going to be hard to... err... un-kill."
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.race
                        equals=troll
                    [/variable]
                    [then]
                        [message]
                            speaker=unit
                            message=_ "Runes broken?"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message=_ "How broken are these runes then?"
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Elyssa
                    message=_ "Step on them and find out. I need to save my magic; that Lich will be hard to... err... un-kill."
                [/message]
            [/else]
        [/if]
    [/event]

#define NON_SAFE_LOCATIONS
    x=15,16,17,18
    y=31,30,32,31
#enddef

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x=14,17
            y=31,33
            side=1
        [/filter]

        [if]
            [have_unit]
                x,y=14,31
                side=1
            [/have_unit]
            [and]
                [have_unit]
                    x,y=17,33
                    side=1
                [/have_unit]
            [/and]
            [and]
                [variable]
                    name=bridge_destroyed
                    equals=no
                [/variable]
            [/and]

            [then]
                [if]
                    [have_unit]
                        {NON_SAFE_LOCATIONS}
                        side=1
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Elyssa
                            message= _"We can't destroy the bridge if one of us is still on it!"
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.race
                                equals=troll
                            [/variable]
                            [then]
                                [message]
                                    speaker=unit
                                    message=_ "Rune not work again."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message=_ "Nothing happened. Typical."
                                [/message]
                            [/else]
                        [/if]

                        [scroll_to]
                            x,y=18,30
                        [/scroll_to]

                        [delay]
                            time=1000
                        [/delay]

                        {THUNDER_AND_LIGHTNING 15 31}

                        [terrain]
                            x=15
                            y=31
                            terrain=Qxu
                        [/terrain]

                        [terrain]
                            x=16
                            y=30
                            terrain=Qxu
                        [/terrain]

                        [kill]
                            x,y=15,31
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [kill]
                            x,y=16,30
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [redraw]
                        [/redraw]

                        [delay]
                            time=750
                        [/delay]

                        [scroll_to]
                            x,y=17,32
                        [/scroll_to]

                        {THUNDER_AND_LIGHTNING 17 32}

                        [terrain]
                            x=17
                            y=32
                            terrain=Qxu
                        [/terrain]

                        [terrain]
                            x=18
                            y=31
                            terrain=Qxu
                        [/terrain]

                        [kill]
                            x,y=17,32
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [kill]
                            x,y=18,31
                            animate=yes
                            fire_event=yes
                        [/kill]

                        [redraw]
                        [/redraw]

                        [set_variable]
                            name=bridge_destroyed
                            value=yes
                        [/set_variable]
                        #			[message]
                        #				speaker=unit
                        #				message= _"Death won't be difficult to find here."
                        #			[/message]
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack

        [filter]
            id=U
        [/filter]

        [message]
            speaker=U
            #message= _ "You can't hit me!"
            message= _ "You can't kill me!"
        [/message]
    [/event]

    [event]
        name=attack

        [filter]
            id=S
        [/filter]

        [message]
            speaker=S
            message= _ "Grrrgghhh." # wmllint: no spellcheck
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=L
        [/filter]

        [message]
            speaker=L
            message= _ "Master, I have failed..."
        [/message]

        [remove_shroud]
            x,y=14,40
            radius=4
            side=1
        [/remove_shroud]

        [if]
            [variable]
                name=second_unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "$second_unit.name see gate."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "Look, a gateway! Maybe we can get out and close it!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Elyssa
            message= _ "Excellent, a way out of this nightmare. Grog, see if you can close it behind us; I don't hold out hope though, my opinion of Dwarvish construction is waning rapidly."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "It <i>should</i> close from the outside; if not..."
        [/message]

        [message]
            speaker=Grog
            message= _ "Hit with hammer."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                x,y=20,49
                radius=5
            [/filter_location]
        [/filter]

        [teleport]
            [filter]
                id=bodyguard_1
            [/filter]
            x=20
            y=48
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=bodyguard_2
            [/filter]
            x=21
            y=48
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=bodyguard_3
            [/filter]
            x=22
            y=48
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=bodyguard_4
            [/filter]
            x=22
            y=49
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=bodyguard_5
            [/filter]
            x=21
            y=50
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=Elyssa
            [/filter]
            x=20
            y=49
            animate=no
        [/teleport]
        [teleport]
            [filter]
                id=Grog
            [/filter]
            x=21
            y=49
            animate=no
        [/teleport]

        [terrain]
            x,y=16,43
            terrain=Xos
        [/terrain]

        [sound]
            name=rumble.ogg
        [/sound]

        [redraw][/redraw]

        [message]
            speaker=narrator
            message= _ "Cogs turn and iron grinds as a heavy gate descends behind them."
            image=wesnoth-icon.png
        [/message]

        # does not work. It seems like teleport erases auto stored unit variable. Maybe I should use move_unit? E_H.
        #[if]
        #	[variable]
        #		name=unit.race
        #		equals=troll
        #	[/variable]
        #	[then]
        #		[message]
        #			speaker=unit
        #			message= _ "What did that."
        #		[/message]
        #	[/then]
        #	[else]
        #		[message]
        #			speaker=unit
        #			message= _ "Who did that?"
        #		[/message]
        #	[/else]
        #[/if]

        [message]
            speaker=Elyssa
            message= _ "It closed itself. How convenient."
        [/message]

        [message]
            speaker=Grog
            # Griknagh is the name of the Trolls' god, as in UtBS. E_H
            message= _ "Thank Griknagh for help Trolls."
        [/message]

        # does not work. Replaced with a message assigned to Grog. E_H.
        #[if]
        #	[variable]
        #		name=unit.race
        #		equals=troll
        #	[/variable]
        #	[then]
        #		[message]
        #			speaker=unit
        #			message= _ "Griknagh now is help us."
        #		[/message]
        #	[/then]
        #	[else]
        #		[message]
        #			speaker=unit
        #			message= _ "Eloh is surely smiling upon us this day."
        #		[/message]
        #	[/else]
        #[/if]

        {TROLL_ROLE_SMALL "shame"}

        [if]
            # this code checks the player's units. If one of them is missing, fires the message. E_H.
            [not]
                [have_unit]
                    id=bodyguard_1
                [/have_unit]
                [have_unit]
                    id=bodyguard_2
                [/have_unit]
                [have_unit]
                    id=bodyguard_3
                [/have_unit]
                [have_unit]
                    id=bodyguard_4
                [/have_unit]
                [have_unit]
                    id=bodyguard_5
                [/have_unit]
            [/not]
            [then]
                [message]
                    role=shame
                    message= _ "Shame we could not release all the prisoners."
                [/message]
            [/then]
        [/if]

        {TROLL_ROLE_BIG "advice"}

        [message]
            role=advice
            message= _ "Gate not last long. Bones go to Troll home now."
        [/message]

        [message]
            speaker=Grog
            message= _ "Grog need go to Troll village."
        [/message]

        [endlevel]
            bonus=yes
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #####################################################
    # CAPTURE CODE (isolated for convenience)
    # we store the units hp before it is attacked
    # if the attack kills it we then store it with the hp
    # it had before it was attacked.
    # we then put a event on the killer to mark our units
    # release when we kill it.
    #####################################################

    # ID CHANGES
    # origionally our unit has ID X then it is stored in
    # "stored_X" the killer gets id X when it in turn gets killed
    # the ids are restored

    # WARNING this code is designed very specially DO NOT TOUCH

    #two talk methods depeding on whether you have heard it before
    [event]
        name=last breath
        first_time_only=yes

        [filter]
            side=1
            [not]
                id=Grog
            [/not]
            [not]
                id=Elyssa
            [/not]
        [/filter]

        #have some conversation
        [message]
            speaker=second_unit
            message= _ "Got you!"
        [/message]

        [if]
            [variable]
                name=unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ " $unit.name says this one stinks."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    # wmllint: local spelling Aaahh!
                    message= _ "Aaahh! Help me!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=narrator
            message=_"To rescue this unit kill its captor."
            image=wesnoth-icon.png
        [/message]

        [event]
            name=last breath
            first_time_only=no

            [filter]
                side=1
                [not]
                    id=Grog
                [/not]
                [not]
                    id=Elyssa
                [/not]
            [/filter]

            #have some conversation
            [message]
                speaker=second_unit
                message= _ "And you as well!"
            [/message]
        [/event]
    [/event]

    #unit death
    #unit = us
    #2unit = undead
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1
            [not]
                id=Grog
            [/not]
            [not]
                id=Elyssa
            [/not]
        [/filter]

        [filter_second]
            side=2,3,4
        [/filter_second]

        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span foreground='red'>unit captured</span>"
        [/floating_text]

        #change the killers id to that of our unit
        #{MODIFY_UNIT (id=$second_unit.id) id ($unit.id)}
        #No, set a variable that tells us who killed the bodyguard. E_H.
        [switch]
            variable=unit.id
            [case]
                value=bodyguard_1
                {VARIABLE bodyguard_1_killed_by $second_unit.id}
            [/case]
            [case]
                value=bodyguard_2
                {VARIABLE bodyguard_2_killed_by $second_unit.id}
            [/case]
            [case]
                value=bodyguard_3
                {VARIABLE bodyguard_3_killed_by $second_unit.id}
            [/case]
            [case]
                value=bodyguard_4
                {VARIABLE bodyguard_4_killed_by $second_unit.id}
            [/case]
            [case]
                value=bodyguard_5
                {VARIABLE bodyguard_5_killed_by $second_unit.id}
            [/case]
        [/switch]

        #store our unit as stored_X
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            kill=yes
            # I haven't any good idea on how to fix this for now, so... E_H.
            variable="stored_"+$unit.id #wmllint: ignore
        [/store_unit]

        #give the killer a icon to show that he has a prisoner
        [unit_overlay]
            id=$second_unit.id
            image=misc/prisoner.png
        [/unit_overlay]

        # this should order the killer to go back to the Lich's castle. E_H.
        [store_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            kill=no
            variable=stored_killer
        [/store_unit]

        {VARIABLE stored_killer.goto_x 40}
        {VARIABLE stored_killer.goto_y 6}

        [unstore_unit]
            variable=stored_killer
        [/unstore_unit]

        {CLEAR_VARIABLE stored_killer}
    [/event]

    #recognise deaths of any killers

    [event]
        name=die
        first_time_only=no

        [filter]
            side=2,3,4
        [/filter]
        [if]
            [variable]
                name=bodyguard_1_killed_by
                equals=$unit.id
            [/variable]
            [then]
                #{VARIABLE stored_bodyguard_1.x $x1}
                #{VARIABLE stored_bodyguard_1.y $y1}
                {VARIABLE stored_bodyguard_1.x $unit.x}
                {VARIABLE stored_bodyguard_1.y $unit.y}
                #{VARIABLE temp_hitpoints $stored_bodyguard_1.max_hitpoints}
                #{VARIABLE_OP temp_hitpoints divide 2}
                #{VARIABLE stored_bodyguard_1.hitpoints ($temp_hitpoints)}
                #{CLEAR_VARIABLE temp_hitpoints}
                {VARIABLE stored_bodyguard_1.hitpoints "$(($stored_bodyguard_1.max_hitpoints)/2)"}

                #give it full movement so it can run away
                {VARIABLE stored_bodyguard_1.moves $stored_bodyguard_1.max_moves}

                #unstore our unit displaying a message on the way
                [unstore_unit]
                    variable=stored_bodyguard_1
                    find_vacant=yes
                    red,green,blue=0,255,0
                    text=_"unit released"
                    check_passability=yes
                [/unstore_unit]

                {CLEAR_VARIABLE stored_bodyguard_1}
                #to confirm that the captor is no more. E_H.
                {VARIABLE bodyguard_1_killed_by none}

                #doesnt work as killer says thankyou!
                #[message]
                #	speaker=$unit.id
                #	message= _ "Thankyou."
                #[/message]

                #have some conversation
                #[message]
                #	# TODO: conditionalise
                #	speaker=second_unit
                #	message= _ "It was nothing!"
                #[/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=bodyguard_2_killed_by
                equals=$unit.id
            [/variable]
            [then]
                #{VARIABLE stored_bodyguard_2.x $x1}
                #{VARIABLE stored_bodyguard_2.y $y1}
                {VARIABLE stored_bodyguard_2.x $unit.x}
                {VARIABLE stored_bodyguard_2.y $unit.y}
                #{VARIABLE temp_hitpoints $stored_bodyguard_2.max_hitpoints}
                #{VARIABLE_OP temp_hitpoints divide 2}
                #{VARIABLE stored_bodyguard_2.hitpoints ($temp_hitpoints)}
                #{CLEAR_VARIABLE temp_hitpoints}
                {VARIABLE stored_bodyguard_2.hitpoints "$(($stored_bodyguard_2.max_hitpoints)/2)"}

                #give it full movement so it can run away
                {VARIABLE stored_bodyguard_2.moves $stored_bodyguard_2.max_moves}

                #unstore our unit displaying a message on the way
                [unstore_unit]
                    variable=stored_bodyguard_2
                    find_vacant=yes
                    red,green,blue=0,255,0
                    text=_"unit released"
                    check_passability=yes
                [/unstore_unit]

                {CLEAR_VARIABLE stored_bodyguard_2}
                #to confirm that the captor is no more. E_H.
                {VARIABLE bodyguard_2_killed_by none}

                #doesnt work as killer says thankyou!
                #[message]
                #	speaker=$unit.id
                #	message= _ "Thankyou."
                #[/message]

                #have some conversation
                #[message]
                #	# TODO: conditionalise
                #	speaker=second_unit
                #	message= _ "It was nothing!"
                #[/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=bodyguard_3_killed_by
                equals=$unit.id
            [/variable]
            [then]
                #{VARIABLE stored_bodyguard_3.x $x1}
                #{VARIABLE stored_bodyguard_3.y $y1}
                {VARIABLE stored_bodyguard_3.x $unit.x}
                {VARIABLE stored_bodyguard_3.y $unit.y}
                #{VARIABLE temp_hitpoints $stored_bodyguard_3.max_hitpoints}
                #{VARIABLE_OP temp_hitpoints divide 2}
                #{VARIABLE stored_bodyguard_3.hitpoints ($temp_hitpoints)}
                #{CLEAR_VARIABLE temp_hitpoints}
                {VARIABLE stored_bodyguard_3.hitpoints "$(($stored_bodyguard_3.max_hitpoints)/2)"}

                #give it full movement so it can run away
                {VARIABLE stored_bodyguard_3.moves $stored_bodyguard_3.max_moves}

                #unstore our unit displaying a message on the way
                [unstore_unit]
                    variable=stored_bodyguard_3
                    find_vacant=yes
                    red,green,blue=0,255,0
                    text=_"unit released"
                    check_passability=yes
                [/unstore_unit]

                {CLEAR_VARIABLE stored_bodyguard_3}
                #to confirm that the captor is no more. E_H.
                {VARIABLE bodyguard_3_killed_by none}

                #doesnt work as killer says thankyou!
                #[message]
                #	speaker=$unit.id
                #	message= _ "Thankyou."
                #[/message]

                #have some conversation
                #[message]
                #	# TODO: conditionalise
                #	speaker=second_unit
                #	message= _ "It was nothing!"
                #[/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=bodyguard_4_killed_by
                equals=$unit.id
            [/variable]
            [then]
                #{VARIABLE stored_bodyguard_4.x $x1}
                #{VARIABLE stored_bodyguard_4.y $y1}
                {VARIABLE stored_bodyguard_4.x $unit.x}
                {VARIABLE stored_bodyguard_4.y $unit.y}
                #{VARIABLE temp_hitpoints $stored_bodyguard_4.max_hitpoints}
                #{VARIABLE_OP temp_hitpoints divide 2}
                #{VARIABLE stored_bodyguard_4.hitpoints ($temp_hitpoints)}
                #{CLEAR_VARIABLE temp_hitpoints}
                {VARIABLE stored_bodyguard_4.hitpoints "$(($stored_bodyguard_4.max_hitpoints)/2)"}

                #give it full movement so it can run away
                {VARIABLE stored_bodyguard_4.moves $stored_bodyguard_4.max_moves}

                #unstore our unit displaying a message on the way
                [unstore_unit]
                    variable=stored_bodyguard_4
                    find_vacant=yes
                    red,green,blue=0,255,0
                    text=_"unit released"
                    check_passability=yes
                [/unstore_unit]

                {CLEAR_VARIABLE stored_bodyguard_4}
                #to confirm that the captor is no more. E_H.
                {VARIABLE bodyguard_4_killed_by none}

                #doesnt work as killer says thankyou!
                #[message]
                #	speaker=$unit.id
                #	message= _ "Thankyou."
                #[/message]

                #have some conversation
                #[message]
                #	# TODO: conditionalise
                #	speaker=second_unit
                #	message= _ "It was nothing!"
                #[/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=bodyguard_5_killed_by
                equals=$unit.id
            [/variable]
            [then]
                #{VARIABLE stored_bodyguard_5.x $x1}
                #{VARIABLE stored_bodyguard_5.y $y1}
                {VARIABLE stored_bodyguard_5.x $unit.x}
                {VARIABLE stored_bodyguard_5.y $unit.y}
                #{VARIABLE temp_hitpoints $stored_bodyguard_5.max_hitpoints}
                #{VARIABLE_OP temp_hitpoints divide 2}
                #{VARIABLE stored_bodyguard_5.hitpoints ($temp_hitpoints)}
                #{CLEAR_VARIABLE temp_hitpoints}
                {VARIABLE stored_bodyguard_5.hitpoints "$(($stored_bodyguard_5.max_hitpoints)/2)"}

                #give it full movement so it can run away
                {VARIABLE stored_bodyguard_5.moves $stored_bodyguard_5.max_moves}

                #unstore our unit displaying a message on the way
                [unstore_unit]
                    variable=stored_bodyguard_5
                    find_vacant=yes
                    red,green,blue=0,255,0
                    text=_"unit released"
                    check_passability=yes
                [/unstore_unit]

                {CLEAR_VARIABLE stored_bodyguard_5}
                #to confirm that the captor is no more. E_H.
                {VARIABLE bodyguard_5_killed_by none}

                #doesnt work as killer says thankyou!
                #[message]
                #	speaker=$unit.id
                #	message= _ "Thankyou."
                #[/message]

                #have some conversation
                #[message]
                #	# TODO: conditionalise
                #	speaker=second_unit
                #	message= _ "It was nothing!"
                #[/message]
            [/then]
        [/if]
        #for some reason, the unstored unit is not immediatly showed. So, redraw. E_H.
        [redraw]
        [/redraw]
    [/event]

    #victory clear variables
    [event]
        name = victory

        # reallow recruitment
        [allow_recruit]
            side=1
            type=Troll Whelp
        [/allow_recruit]

        #restore recall list
        {FOREACH Grog_recall_list index}
            [unstore_unit]
                variable=Grog_recall_list[$index]
                x,y=recall,recall
            [/unstore_unit]
        {NEXT index}

        {CLEAR_VARIABLE Grog_recall_list}

        {CLEAR_VARIABLE "hp_before_attack"}

        #don't clear these as we will use them again in A7
        #{CLEAR_VARIABLE "stored_bodyguard_1"}
        #{CLEAR_VARIABLE "stored_bodyguard_2"}
        #{CLEAR_VARIABLE "stored_bodyguard_3"}
        #{CLEAR_VARIABLE "stored_bodyguard_4"}
        #{CLEAR_VARIABLE "stored_bodyguard_5"}

        #but these instead no longer serve any purpose. E_H.
        {CLEAR_VARIABLE bodyguard_1_killed_by}
        {CLEAR_VARIABLE bodyguard_2_killed_by}
        {CLEAR_VARIABLE bodyguard_3_killed_by}
        {CLEAR_VARIABLE bodyguard_4_killed_by}
        {CLEAR_VARIABLE bodyguard_5_killed_by}
        {CLEAR_VARIABLE bridge_destroyed}
    [/event]

    {~add-ons/The_Sojournings_of_Grog/utils/tsog-deaths.cfg}
[/scenario]
