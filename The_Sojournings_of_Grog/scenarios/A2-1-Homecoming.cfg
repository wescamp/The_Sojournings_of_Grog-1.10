#textdomain wesnoth-tsog

#
# !!!READ_THIS_FIRST!!!
#
# MAP
#
# There is a patch of desert to the north-west where Grog Elyssa and the Elves start.
# Infront of them is the entrance to the caves.
# Just inside the caves a road stretches away but is blocked just inside.
# to the north of the road is a dwarvish stronghold with a passage behind it leading through
#   some spiders to Grogs home
# to the south is a path that leads around the blockage in the road and rejoins.
# Grog's home is in the NE and is surrounded by a stream.
#
# STRATEGY
#
# You can take one or both of two paths once inside the caves. Both are relatively simple.
#
# VARIABLES
# troll_villages_captured = how many troll villages have you captured
# bridge_destroyed = have you collapsed the bridge in the south passage
# discovered = have the dwarvish guards discovered you. ie
#   did the guards return from their pint-o-ale and see you
#   or did you take the northern route after they had returned
#   or did the dwarvish patrol discover you
# met_patrol = if you dont get discovered the south tunnel is very boring so we have a
#   dwarvish patrol that meets you.
#
# TODO
# 1) The current method for stopping the dwarves on the way back doesnt work perfectly.
#    The dwarves stop on the wrong side of the unit
#
# NOTES
#
# 1) Please don't change the dialog in this scenario.
#

# wmllint: recognize Zurg
# wmllint: recognize dwarfboss2

[scenario]
    id=A2-1
    name =_"The Homecoming"
    next_scenario=A2-2

    {TURNS 50 45 40}
    map_data="{~add-ons/The_Sojournings_of_Grog/maps/A2-1-Homecoming.map}"
    victory_when_enemies_defeated=no

    {UNDERGROUND}

#ifhave ~add-ons/UMC_Music/_main.cfg
    # wmlscope: start ignoring
    {INTRO_AND_SCENARIO_MUSIC "heroes_rite.ogg" "suspense.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "gameplay06.ogg"}
    # wmlscope: stop ignoring
#else
    {INTRO_AND_SCENARIO_MUSIC "heroes_rite.ogg" "suspense.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
#endif

    [story]
        [part]
            story= _ "The party, now joined by Elyssa soon left the bandits behind them and began the long, slow climb up into the mountains that bordered Grog's home. Elyssa led them to a little used entrance to the caves high up in the mountains."
            background=story/desertnight.jpg
        [/part]
    [/story]

    [side]
        side=1
        controller=human
        team_name=goodies
        user_team_name=_"Goodies"

        {GOLD 100 80 60}
        {INCOME 6 4 2}

        shroud=yes

        {GROG}
        type="Grog Hero"

        {TROLL_FLAG}
    [/side]

    #
    # Dwarvish Gate-guard force
    #
    [side]
        type=Dwarvish Steelclad
        id=dwarfboss1
        side=2
        team_name=dwarves
        user_team_name= _ "Dwarves"
        generate_name=yes

        canrecruit=yes
        #recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman

        {GOLD 75 100 125}
        {INCOME 2 4 6}

        [ai]
            passive_leader=yes
        [/ai]

        {FLAG_VARIANT knalgan}
    [/side]

    #
    # Dwarves in Grog's Home
    #
    [side]
        type=Dwarvish Steelclad
        id=dwarfboss2
        side=3
        team_name=dwarves
        user_team_name= _ "Dwarves"
        generate_name=yes

        canrecruit=yes
        #recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman

        {GOLD 100 125 150}
        {INCOME 0 2 4}

        [ai]
            passive_leader=yes

            #avoid leaving the 'home area'
            [avoid]
                x=38,39,37,45
                y=2, 9, 17,22
                # radius increased from 3 to 5 to avoid the Dwarves triggering the Giant Spiders, that have more moves. E_H.
                radius=5
            [/avoid]
        [/ai]

        {FLAG_VARIANT knalgan}
    [/side]

    #
    # Bats near Grog's home
    #
    [side]
        type=Dread Bat
        id=batboss
        generate_name=yes
        side=4

        team_name=bats
        user_team_name= _ "Bats"

        {GOLD 75 85 95}
        {INCOME 4 5 6}

        canrecruit=yes
        #recruit=Vampire Bat,Blood Bat

        [ai]
            passive_leader=yes

            #avoid leaving the 'home area'
            [avoid]
                x=40,41,39,37,46
                y=2, 9, 11,15,21
                radius=3
            [/avoid]

            #we want the bats to go north from their castle so
            [avoid]
                x=47
                y=17
                radius=4
            [/avoid]

            #target home castle
            [target]
                x=51
                y=11
                value=1
            [/target]
        [/ai]
    [/side]

    #
    # Monster's side
    # (Spiders, Ants, etc)
    #
    [side]
        no_leader=yes
        side=5
        team_name=monsters
        user_team_name= _ "Monsters"

        [ai]
            aggression=1.0
            caution=0.00
        [/ai]
    [/side]

    [time_area]
        x=0,   1-3, 4,   5,   6-7, 8-9, 10,  11, 12-15,16, 17
        y=0-12,0-13,0-12,0-13,0-12,0-11,0-10,0-9,0-7,  2-5,4-5
        {TWO_SUNS_DEFAULT_SCHEDULE}
    [/time_area]

    [time_area]
        # runes are placed at 12,24 and 14,23
        x=   11,   12,   13,   14,   15
        y=24-25,23-25,23-25,22-24,23-24
        {RUNIC}
    [/time_area]

    #
    # Prestart
    #
    [event]
        name=prestart

        {VARIABLE troll_villages_captured 0}
        {VARIABLE bridge_destroyed no}
        {VARIABLE discovered no}
        {VARIABLE met_patrol no}
        {VARIABLE attacked_lads no}
        {VARIABLE gave_home_direction no}

        [unit]
            side=2
            type=Dwarvish Stalwart
            x,y=16,9
            id=guard1
            [modifications]
                {TRAIT_DRUNK}
            [/modifications]
        [/unit] {GUARDIAN}
        [unit]
            side=2
            type=Dwarvish Thunderguard
            x,y=14,10
            id=guard2
            [modifications]
                {TRAIT_DRUNK}
            [/modifications]
        [/unit] {GUARDIAN}
        {GENERIC_UNIT 2 "Dwarvish Fighter" 13 9} {GUARDIAN}
        [+unit]
            role=lad
        [/unit]
        {GENERIC_UNIT 2 "Dwarvish Thunderer" 14 9} {GUARDIAN}
        [+unit]
            role=lad
        [/unit]
        {GENERIC_UNIT 2 "Dwarvish Guardsman" 13 10} {GUARDIAN}
        [+unit]
            role=lad
        [/unit]

#ifdef HARD
        {GENERIC_UNIT 5 "Giant Spider" 37 1} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Spider" 34 5} {GUARDIAN}
#else
        {GENERIC_UNIT 5 "Cave Spider" 37 1} {GUARDIAN}
        {GENERIC_UNIT 5 "Cave Spider" 34 5} {GUARDIAN}
#endif

#ifdef HARD
        {GENERIC_UNIT 5 "Giant Spider" 36 17} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Spider" 43 23} {GUARDIAN}
#else
        {GENERIC_UNIT 5 "Cave Spider" 36 17} {GUARDIAN}
        {GENERIC_UNIT 5 "Cave Spider" 43 23} {GUARDIAN}
#endif

        {GENERIC_UNIT 3 "Dwarvish Guardsman" 45 4} {GUARDIAN}
        {GENERIC_UNIT 3 "Dwarvish Guardsman" 45 8} {GUARDIAN}
        {GENERIC_UNIT 3 "Dwarvish Guardsman" 44 13} {GUARDIAN}
        {GENERIC_UNIT 3 "Dwarvish Guardsman" 49 17} {GUARDIAN}
        {GENERIC_UNIT 3 "Dwarvish Guardsman" 53 17} {GUARDIAN}

        # add some Ants, same side of Spiders. With their stats lowered, they aren't much of a threat. E_H.
        {GENERIC_UNIT 5 "Giant Ant" 34 18} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 36 20} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 40 21} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 42 24} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 20 22} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 23 22} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 26 21} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 20 26} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 23 27} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 29 27} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 31 28} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 32 24} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 25 23} {GUARDIAN}
        {GENERIC_UNIT 5 "Giant Ant" 28 22} {GUARDIAN}

        [remove_shroud]
            side=1
            x=0,   1-3, 4,   5,   6-7, 8-9, 10,  11, 12-15,16, 17,  18
            y=0-13,0-14,0-13,0-14,0-13,0-12,0-11,0-10,0-8,  1-6,3-6,3-6
        [/remove_shroud]

        [remove_shroud]
            side=1
            x=14,15,16,17,18
            y=9, 10,10,11,11
            radius=3
        [/remove_shroud]

        #placing the special White Troll. Thanks Wesnoth Italian Forum. E_H.
        {PLACE_IMAGE "units/trolls/white_whelp.png~RC(magenta>red)" 27 5}
        {PLACE_IMAGE items/cage.png 27 5}

        [objectives]
            side=1
            [objective]
                description= _"Find Grog's home."
                condition=win
            [/objective]
            [objective]
                description= _"Death of Grog"
                condition=lose
            [/objective]
            [objective]
                description= _"Death of Elyssa"
                condition=lose
            [/objective]
            [objective]
                description= _"Time runs out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #
    # Start
    #
    [event]
        name=start

        [recall]
            id=Elyssa
            x,y=6,5
            show=no
        [/recall]

        [recall]
            id=Arcamenel
            x,y=4,7
            show=no
        [/recall]

        [recall]
            id=Bedet
            x,y=11,4
            show=no
        [/recall]

        [recall]
            id=Calaelen
            x,y=10,5
            show=no
        [/recall]

        [recall]
            id=Defu
            x,y=3,6
            show=no
        [/recall]

        [recall]
            id=Falassion
            x,y=5,4
            show=no
        [/recall]

        [recall]
            id=Heka
            x,y=8,2
            show=no
        [/recall]

        [recall]
            id=mudcrawler
            x,y=9,9
            show=no
        [/recall]

        [redraw]
        [/redraw]

        [message]
            speaker=Elyssa
            message= _"<span size='small' style='italic'>We must be quiet here; we don't want to alert the guards until we have to.</span>"
        [/message]

        [message]
            speaker=guard1
            message= _"Hah! Ever since that ruddy mage escaped we've been on triple guard, in all weathers! Not a drop of ale to drink either - How can a Dwarf do his duty without ale?"
        [/message]

        [message]
            speaker=guard2
            message= _"Aye! Say, how 'bout we go grab ourselves a quick flagon? The lads here can keep an eye on things." # wmllint: no spellcheck
        [/message]

        [message]
            speaker=guard1
            # wmllint: local spelling un-told Oi
            message= _"Aye, let the new lads guard us from the un-told horrors. Oi, you, keep a good eye on that... uh... dangerous looking tree. Hah!"
        [/message]

        [move_unit]
            id=guard1
            to_x=27
            to_y=9
        [/move_unit]
        [move_unit]
            id=guard2
            to_x=28
            to_y=9
        [/move_unit]

        [message]
            speaker=Elyssa
            message= _"Heh, excellent, you can always rely on a Dwarves' need for ale! Let's get inside before they return."
        [/message]
    [/event]

    #####################################################################################################
    #####################################################################################################
    ### Gate_Section
    ###
    ### Contains code controling the action around the gates.
    #####################################################################################################
    #####################################################################################################

    #
    # The guards return.
    # If they discover you then they raise the alarm
    # If not then they comment about where the others have gone and start guarding
    #
    [event]
#ifdef HARD
        name=side 2 turn 6
#else
        name=side 2 turn 7
#endif

        [if]
            [variable]
                name=discovered
                equals=no
            [/variable]

            [then]
                {VARIABLE result 0}

                #follows a bit of code that works out the first unit that the guards meat on their return.
                #it assumes that search lists are evealuated left to right
                [store_unit]
                    [filter]
                        side=1
                        [filter_location]
                            x=26,24,22,20,18,16,16,14
                            y=11,11,12,11,10,10,9, 10
                            radius=4
                        [/filter_location]
                    [/filter]
                    variable=result
                [/store_unit]

                [if]
                    [variable]
                        name=result.length
                        equals=0
                    [/variable]

                    [then]
                        [move_unit]
                            id=guard1
                            to_x=16
                            to_y=9
                        [/move_unit]
                        [move_unit]
                            id=guard2
                            to_x=14
                            to_y=10
                        [/move_unit]

                        [if]
                            [have_unit]
                                role=lad
                            [/have_unit]

                            [then]
                                #we assume at this point that you attacked them and didn't kill all of them.
                                #this means one of the lads tells the guards and you are discovered.
                                #You could check to see whether they were attacked but that would involve the following(I think)
                                #events for:
                                # you attack them
                                # they attack you
                                # you move near them
                                # they move at all
                                #I dont think that it is worth the small benefit of catering to someone who plays abnormally.
                                [message]
                                    speaker=guard1
                                    message= _"That was a nice cup o' ale."
                                [/message]

                                [message]
                                    role=lad
                                    message= _"Oh, sir, finally you're back. We were attacked. It was that mage again!"
                                [/message]

                                [message]
                                    speaker=guard1
                                    # wmllint: local spelling Hic
                                    message= _"Where? I'll get them. Sound the alarm... <i>Hic</i>."
                                    sound=name=horn-signals/horn-2.ogg
                                [/message]

                                [fire_event]
                                    name=discovered
                                [/fire_event]
                            [/then]
                            [else]
                                [message]
                                    speaker=guard1
                                    message= _"Now I wonder where the lads got to."
                                [/message]

                                [message]
                                    speaker=guard2
                                    message= _"Sure is strange. Not like there's anything around here to see anyway. Oh well, they'll turn up."
                                [/message]
                            [/else]
                        [/if]
                    [/then]

                    [else]
                        #This code is flawed. what we want is to have them stop on their side.
                        #normally the code doesnt do this but hey! - Eros
                        # worry not, Eros. move_unit and FAI should do the trick in most cases. E_H.

                        [move_unit]
                            id=guard1
                            to_x,to_y="$($result.x+1)","$($result.y-1)" # use of FormulaAI notation
                            # DO NOT REMOVE QUOTES, OTHERWISE IT'LL NO LONGER WORK
                        [/move_unit]

                        [move_unit]
                            id=guard2
                            to_x,to_y="$($result.x+1)","$($result.y+1)"
                        [/move_unit]

                        [message]
                            speaker=guard1
                            message= _"Hey, wait! Intruders! Sound the alarm... <i>Hic</i>."
                            sound=horn-signals/horn-2.ogg
                        [/message]

                        [fire_event]
                            name=discovered
                        [/fire_event]
                    [/else]
                [/if]

                {CLEAR_VARIABLE result}
            [/then]
        [/if]
    [/event]

    #
    # You sight guard1, guard2.
    # called if you move near to where they are standing.
    # fires discovered.
    #
    [event]
        name=sighted

        [filter]
            id=guard1
            [or]
                id=guard2
            [/or]
        [/filter]

        [if]
            [variable]
                name=discovered
                equals=no
            [/variable]

            [then]
                [message]
                    speaker=guard1
                    message= _"Hey, wait! Intruders! Sound the alarm... <i>Hic</i>."
                    sound=horn-signals/horn-2.ogg
                [/message]

                [fire_event]
                    name=discovered
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #
    # You sight dwarfboss1
    # This can only happen if you go north after the guards return
    #
    [event]
        name=sighted

        [filter]
            id=dwarfboss1
        [/filter]
        [if]
            [variable]
                name=discovered
                equals=no
            [/variable]

            [then]
                [message]
                    speaker=dwarfboss1
                    message= _"Intruders! Where are those guards gone? Sound the alarm!"
                    sound=horn-signals/horn-2.ogg
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "Sounds like we've been discovered."
                [/message]

                #TODO end turn

                [fire_event]
                    name=discovered
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #
    # You are discovered
    #
    [event]
        name=discovered

        # code for removing special guardian status from side 2 units.
        # It sets the ai_special to none, but I have no idea how Wesnoth will handle this. E_H.
        [modify_unit]
            [filter]
                side=2
            [/filter]
            ai_special=none
        [/modify_unit]

        [allow_recruit]
            side=2
            type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman
        [/allow_recruit]

        [set_variable]
            name=discovered
            value=yes
        [/set_variable]

        [capture_village]
            x,y=24,5
            side=2
        [/capture_village]

        [capture_village]
            x,y=30,8
            side=2
        [/capture_village]

        [capture_village]
            x,y=29,8
            side=2
        [/capture_village]

        [capture_village]
            x,y=28,10
            side=2
        [/capture_village]
    [/event]

    #
    # You cross the bridges and enter the main tunnel.
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=16,17,   18,   19,   20,   21,   22
                y=12,12-13,11-13,11-14,10-14,12-15,11-15
            [/filter_location]
        [/filter]

        [remove_shroud]
            side=1
            x=27-30
            y=14-19
        [/remove_shroud]

        [redraw]
        [/redraw]

        [message]
            speaker=Elyssa
            message= _ "We must choose our route carefully here, we can't stay on the main road as it collapsed during the war; we can go north or south."
        [/message]

        #TODO: fix this role
        {ELF_ROLE_MALE gosouth}

        [message]
            role=gosouth
            message= _ "It looks as if the Dwarves have built a guard-post to the north; the southern route looks mostly empty."
        [/message]

        [if]
            [have_unit]
                role=lad
            [/have_unit]

            [and]
                [variable]
                    name=discovered
                    equals=no
                [/variable]
            [/and]

            [then]
                {ELF_ROLE_FEMALE killlads}

                [message]
                    role=killlads
                    message= _ "We had better kill the remaining guards though, we don't want to leave any witnesses behind us."
                [/message]
            [/then]
        [/if]

        # an hint about where the White Troll is... E_H.
        [message]
            speaker=Elyssa
            message= _ "Yes, the main Dwarfish settlement is up to the north, that's where they held me. I don't know if they're now holding other prisoners, though."
        [/message]
    [/event]

    #
    # Say stuff when you kill the gate guard garrison leader
    #
    [event]
        name=last breath

        [filter]
            id=dwarfboss1
        [/filter]

        [message]
            speaker=Elyssa
            message=_"This garrison was under strength, I expected every entrance to be nigh impregnable; where are all the Dwarves? This makes me very uneasy."
        [/message]
    [/event]

    ##########################
    # Gate_Section >> Patrol #
    ##########################

    #
    # You trigger the patrol. only fired if you havent been "discovered".
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=11
                y=17
                radius=2
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=discovered
                equals=no
            [/variable]

            [then]
                [remove_shroud]
                    side=1
                    x=11,11
                    y=18,20
                    radius=3
                [/remove_shroud]

                [redraw]
                [/redraw]

                # I changed them to L1 (were Pathfinder, Steelclad, Thunderguard and Guardsman)
                # because they appeared just a bit too strong for me on Easy. Just my opinion. E_H.
                [unit]
                    side=2
#ifdef EASY
                    type=Dwarvish Scout
#else
                    type=Dwarvish Pathfinder
#endif
                    x,y=14,24
                    id=patrol1
                    role=patrol
                [/unit]

                [unit]
                    side=2
#ifdef HARD
                    type=Dwarvish Steelclad
#else
                    type=Dwarvish Fighter
#endif
                    x,y=15,24
                    id=patrol2
                    role=patrol
                [/unit]

                [unit]
                    side=2
#ifdef HARD
                    type=Dwarvish Thunderguard
#else
                    type=Dwarvish Thunderer
#endif
                    x,y=15,25
                    id=patrol3
                    role=patrol
                [/unit]

                [unit]
                    side=2
#ifdef EASY
                    type=Dwarvish Guardsman
#else
                    type=Dwarvish Stalwart
#endif
                    x,y=16,24
                    id=patrol4
                    role=patrol
                [/unit]

                [move_unit]
                    id=patrol1
                    to_x=11
                    to_y=21
                [/move_unit]
                [move_unit]
                    id=patrol2
                    to_x=10
                    to_y=19
                [/move_unit]
                [move_unit]
                    id=patrol3
                    to_x=11
                    to_y=20
                [/move_unit]
                [move_unit]
                    id=patrol4
                    to_x=11
                    to_y=19
                [/move_unit]

                [message]
                    speaker=patrol1
                    # wmllint: local spelling Hrumph!
                    message= _ "Hrumph! You ask me why I'm so angry about patrolling the south tunnel all the time? I'll tell you why! Because it's dammed well empty all the time!"
                [/message]

                [message]
                    speaker=patrol2
                    message= _ "Captain... It doesn't look so empty this time."
                [/message]

                [message]
                    speaker=patrol1
                    message= _ "What are you talking ab... Ohhh... Hey! You! Stop right there!"
                [/message]

                [message]
                    speaker=Grog
                    message= _ "Squash Dwarves. They tell friends, Grog squash all Dwarves."
                [/message]

                [set_variable]
                    name=met_patrol
                    value=yes
                [/set_variable]
            [/then]
        [/if]
    [/event]

    #
    # The patrol gets past you. It normally looks good but there are rediculous times when it doesn't.
    #
    [event]
        name=moveto

        [filter]
            role=patrol
            x=13,14,14,15
            y=15,15,14,15
        [/filter]

        [if]
            [variable]
                name=discovered
                equals=no
            [/variable]

            [then]
                [move_unit]
                    id=$unit.id
                    to_x=27
                    to_y=7
                [/move_unit]

                [message]
                    speaker=unit
                    message= _ "Sound the alarm!"
                [/message]

                [sound]
                    name=horn-signals/horn-2.ogg
                [/sound]

                [message]
                    speaker=Elyssa
                    message= _ "Bother, they alerted the others. Oh well there's a bridge up ahead. We may be able to hold them there."
                [/message]

                [fire_event]
                    name=discovered
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #
    # All the patrol are killed
    #
    [event]
        name=die
        first_time_only=no

        [filter]
            role=patrol
        [/filter]

        [if]
            [not]
                [have_unit]
                    role=patrol
                [/have_unit]
            [/not]
            [and]
                [variable]
                    name=discovered
                    equals=no
                [/variable]
            [/and]

            [then]
                [message]
                    speaker=Elyssa
                    message= _"I wonder what war their leader was referring to..."
                [/message]
            [/then]
        [/if]
    [/event]

    ##########################
    # Gate_Section >> Bridge #
    ##########################

    #
    # Moveto: you see the runes
    #
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x=14,12
                y=23,24
                radius=4
            [/filter_location]
        [/filter]

        [remove_shroud]
            x=14,12
            y=23,24
            radius=2
            side=1
        [/remove_shroud]

        [redraw]
        [/redraw]

        [message]
            speaker=Grog
            message= _"Grog see Dwarf magic stones. Dem dangerous."
        [/message]

        [message]
            speaker=Elyssa
            message= _"Dwarves use runes for many things, but these look like defensive ones - they will likely collapse the bridge if we stand on them."
        [/message]

        {ELF_ROLE_FEMALE wait}

        [message]
            role=wait
            message= _"Then we can cut off any potential pursuers; make sure we are all across first!"
        [/message]
    [/event]

    #
    # Elyssa destroys the bridge
    #
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x=14,12
            y=23,24
            side=1
        [/filter]

        [filter_condition]
            [have_unit]
                x,y=14,23
                side=1
            [/have_unit]

            [have_unit]
                x,y=12,24
                side=1
            [/have_unit]

            [variable]
                name=bridge_destroyed
                equals=no
            [/variable]
        [/filter_condition]

        [if]
            [variable]
                name=unit.id
                equals=mudcrawler
            [/variable]
            [then]
                [message]
                    speaker=mudcrawler
                    message= _ "Blaaarb..." # wmllint: no spellcheck
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.id
                        equals=Grog
                    [/variable]
                    [then]
                        [message]
                            speaker=Grog
                            message= _ "Grog still see bridge. Bad Dwarf magic."
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.id
                                equals=Elyssa
                            [/variable]
                            [then]
                                [message]
                                    speaker=Elyssa
                                    message= _ "Hah! Trusty Dwarf magic..."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message= _ "The runes appear to be broken."
                                [/message]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

        [if]
            [variable]
                name=unit.id
                not_equals=Grog
            [/variable]

            [then]
                [message]
                    speaker=Grog
                    message= _"Runes not work normally. Dwarf magic bad."
                [/message]
            [/then]
        [/if]

        [message]
            speaker=Elyssa
            # wmllint: local spelling Nevermind
            message= _"Nevermind. I'll just have to do it myself."
        [/message]

        [scroll_to]
            x,y=13,22
        [/scroll_to]

        [delay]
            time=1000
        [/delay]

        {THUNDER_AND_LIGHTNING 12 21}

        [terrain]
            x=12
            y=21
            terrain=Qxu
        [/terrain]

        [kill]
            x,y=12,21
            animate=yes
            fire_event=yes
        [/kill]

        [redraw]
        [/redraw]

        [delay]
            time=750
        [/delay]

        {THUNDER_AND_LIGHTNING 13 23}

        [terrain]
            x=13
            y=23
            terrain=Qxu
        [/terrain]

        [kill]
            x,y=13,23
            animate=yes
            fire_event=yes
        [/kill]

        [redraw]
        [/redraw]

        [message]
            speaker=Elyssa
            message= _ "Onwards!"
        [/message]

        [set_variable]
            name=bridge_destroyed
            value=yes
        [/set_variable]
    [/event]

    #################################
    # Gate_Section >> North Passage #
    #################################

    #
    # You move into the northern tunnel
    #
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x=25,24,24
                y=3, 3, 4
            [/filter_location]
        [/filter]

        [message]
            speaker=unit
            message=_ "It's a path stop..."
        [/message]
    [/event]

    #
    # You reach the end of the northern tunnel
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x,y=26,3
            [/filter_location]
        [/filter]

        [scroll_to]
            x,y=26,3
        [/scroll_to]

        [if]
            [variable]
                name=unit.id
                equals=Grog
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=mudcrawler
                [/variable]
            [/or]

            [then]
                #TODO have grog bash it open with his hammer if he discovers it.
                # But this will mean that we'll no longer see those amazing lightning bolts... E_H.

                [message]
                    speaker=Grog
                    message=_ "Grog thinks that this tunnel was blocked by dwarvish midgets."
                [/message]
            [/then]

            [else]
                [message]
                    speaker=unit
                    message=_ "Ahh... The tunnel continues but the passage has been blocked..."
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Elyssa
            message= _ "Stand back!"
        [/message]

        [if]
            [variable]
                name=unit.id
                not_equals=Elyssa
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        id=Elyssa
                    [/filter]
                    variable=stored_Elyssa
                [/store_unit]

                [move_unit]
                    id=Elyssa
                    to_x=25
                    to_y=3
                [/move_unit]
            [/then]
        [/if]

        [delay]
            time=450
        [/delay]

        [remove_shroud]
            x,y=27,3
            radius=3
            side=1
        [/remove_shroud]

        [scroll_to]
            x,y=27,3
        [/scroll_to]

        {THUNDER_AND_LIGHTNING 27 3}

        [terrain]
            x=27
            y=3
            terrain=Uu^Dr
        [/terrain]

        [redraw]
        [/redraw]

        [sound]
            name=cave-in.ogg
        [/sound]

        [if]
            [variable]
                name=unit.id
                not_equals=Elyssa
            [/variable]
            [then]
                [move_unit]
                    id=Elyssa
                    to_x=$stored_Elyssa.x
                    to_y=$stored_Elyssa.y
                [/move_unit]
                {CLEAR_VARIABLE stored_Elyssa}
            [/then]
        [/if]
    [/event]

    #event for freeing the White Troll.
    [event]
        name=moveto
        [filter]
            side=1
            x,y=27,5
        [/filter]
        [remove_item]
            x,y=27,5
        [/remove_item]

        [unit]
            side=1
            type=White Whelp
            x,y=27,5
            id=Krunk
            name= _ "Krunk"
            placement=map_passable
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        #COMMENT This dialog needs redoing and I (Eros) will do it when I have had clarification on the role of a white troll. :-)

        [message]
            speaker=Krunk
            message= _ "Krunk say thank you. Little cage too small for Krunk."
        [/message]
        # there is still something that Elyssa haven't yet seen... E_H.
        [message]
            speaker=Elyssa
            message= _ "Unbelievable! You are a White Troll? I have heard tales of your kind but I thought it was a myth, but now, here... in front of my own eyes..."
        [/message]
        [message]
            speaker=Grog
            message= _ "Grog not seen White Troll before. White Troll are secret, dey live away from other Trolls."
        [/message]
        [message]
            speaker=Krunk
            message= _ "White Trolls take long time to learn magic. White Troll go away then come back with power. Dwarves find me and into little cage. Dwarves need to die!"
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            # wmllint: local spelling AMLA
            message= _ "White Trolls are extremely rare albino Trolls with a peculiar magic talent. They have an innate capability to create magic constructs of mud and soil and throw them at their enemies - but their spells aren't as powerful as more intelligent creatures. They also don't advance normally, but instead have an AMLA system. Being so rare, this is your only White Troll for the whole campaign. Make good use of him!"
        [/message]
    [/event]

    #####################################################################################################
    #####################################################################################################
    ### Passage_Section
    ###
    ### Contains code for the passages.
    ###
    ### passages = either after the bridge in the S
    ###   or past the secret door in the N and
    ###   before you cross the river to Grog's home
    ###   and chasm drop
    #####################################################################################################
    #####################################################################################################

    #
    # When you move to 10,15 the chasm collapses
    #
    [event]
        name=moveto

        [filter]
            side=1
            x=10
            y=15
        [/filter]

        [sound]
            name=rumble.ogg
        [/sound]

        [if]
            [variable]
                name=unit.id
                equals=mudcrawler
            [/variable]
            [then]
                [message]
                    speaker=mudcrawler
                    message= _ "Blurgle scurgle!" # wmllint: no spellcheck
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.id
                        equals=Grog
                    [/variable]
                    [then]
                        [message]
                            speaker=Grog
                            message= _ "Grog dun think this ground is safe."
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.id
                                equals=Elyssa
                            [/variable]
                            [then]
                                [message]
                                    speaker=Elyssa
                                    # wmllint: local spelling Ach!
                                    message= _ "Ach! The ground here is very unstable."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message= _ "Oh Eloh! This doesn't seem very safe."
                                [/message]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

        {REPEAT 5 ({QUAKE (rumble.ogg)})}

        [if]
            [variable]
                name=unit.id
                equals=mudcrawler
            [/variable]
            [then]
                [message]
                    speaker=mudcrawler
                    message= _ "Blaaarrt!" # wmllint: no spellcheck
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.id
                        equals=Grog
                    [/variable]
                    [then]
                        [message]
                            speaker=Grog
                            message= _ "Grog say go!"
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.id
                                equals=Elyssa
                            [/variable]
                            [then]
                                [message]
                                    speaker=Elyssa
                                    # wmllint: local spelling Woah
                                    message= _ "Woah... Everyone get back!"
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message= _ "Oh Eloh... Back!"
                                [/message]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

        [move_unit]
            id=$unit.id
            to_x=11
            to_y=16
        [/move_unit]

        {REPEAT 5 ({QUAKE (rumble.ogg)})}

        [terrain]
            x=10
            y=15
            terrain=Qxu
        [/terrain]

        [redraw]
            side=1
        [/redraw]

        # why this message isn't showed? E_H.
        [if]
            [variable]
                name=unit.id
                equals=mudcrawler
            [/variable]
            [then]
                [message]
                    speaker=mudcrawler
                    message= _ "Glorb! Phew!" # wmllint: no spellcheck
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.id
                        equals=Grog
                    [/variable]
                    [then]
                        [message]
                            speaker=Grog
                            message= _ "Grog safe now. That was close!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message= _ "Phew that was close!"
                        [/message]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    #
    # Bonus for going across the chasm. Large because no one ever will.
    #
    [event]
        name=moveto

        [filter]
            side=1
            x=2
            y=20
        [/filter]

        [sound]
            name=gold.ogg
        [/sound]

        [message]
            speaker=narrator
            message= _ "In this village you discover a small fortune. It appears that whoever used to live here wasn't too stuck for this worlds possessions."
            image=wesnoth-icon.png
        [/message]

#ifdef EASY
        [gold]
            side=1
            amount=450
        [/gold]
#endif
#ifdef NORMAL
        [gold]
            side=1
            amount=400
        [/gold]
#endif
#ifdef HARD
        [gold]
            side=1
            amount=350
        [/gold]
#endif
    [/event]

    #sighted event for ant
    [event]
        name=sighted

        [filter]
            type=Giant Ant
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [if]
            [variable]
                name=second_unit.id
                equals=Grog
            [/variable]
            [then]
                [message]
                    speaker=Grog
                    message=_ "Grog see ants!"
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=second_unit.id
                        equals=Elyssa
                    [/variable]
                    [then]
                        [message]
                            speaker=Elyssa
                            message=_ "It looks like this tunnel is overrun with giant ants!"
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=second_unit.id
                                equals=mudcrawler
                            [/variable]
                            [then]
                                [message]
                                    speaker=mudcrawler
                                    message= _ "Blaart! Scrupple!" # wmllint: no spellcheck
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=second_unit
                                    message=_ "Those ants are the size of scorpions!"
                                [/message]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

        [message]
            speaker=Elyssa
            message=_ "I suppose there is probably a good reason for so many ants to be here, though..."
        [/message]
    [/event]

    #
    # Sighted event for spiders.
    #

    [event]
        name=sighted

        [filter]
            type=Giant Spider,Cave Spider
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Elyssa
            message= _ "Ahh, yes... Spiders as big as my head; that will be why!"
        [/message]
    [/event]

    #
    # You re-enter the main road
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=34,41
                y=19,26
                radius=3
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=gave_home_direction
                equals=no
            [/variable]
            [then]
                {ELF_ROLE_FEMALE wherearethedwarves}

                [message]
                    role=wherearethedwarves
                    message= _ "Where <i>are</i> the Dwarves? These tunnels are deserted!"
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "I don't think there are enough of them to populate the entire cave anymore, and if they are indeed in another war... Grog's home is close now though."
                [/message]

                {VARIABLE gave_home_direction yes}
            [/then]
        [/if]
    [/event]

    #
    # You enter the cave on the northern passage
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=30
                y=2
                radius=2
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Grog
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=mudcrawler
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=Grog
                    message=_ "Grog think what in here?"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "I suppose there was probably a good reason for blocking it up though..."
                [/message]
            [/else]
        [/if]
    [/event]

    #
    # You leave the cave on the northern passage
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                #x=34,35, 36, 37,38,39,40
                #y=6, 7-8,7-8,9, 2, 3, 2
                x=38,38
                y= 2, 9
                radius=3
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=gave_home_direction
                equals=no
            [/variable]
            [then]
                [message]
                    speaker=Elyssa
                    message= _ "Grog, your home is just ahead."
                [/message]

                {VARIABLE gave_home_direction yes}
            [/then]
        [/if]
    [/event]

    #
    # You try to go south down the main road rather than to Grog's home
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=39,   40,   41,   42,   43
                y=29-31,29-30,29-31,29-30,29-31
            [/filter_location]
        [/filter]

        [remove_shroud]
            side=1
            x=39,   40,   41,   42,   43
            y=29-31,29-30,29-31,29-30,29-31
        [/remove_shroud]

        [redraw]
        [/redraw]

        [message]
            speaker=Elyssa
            message= _ "Don't go that way. Grog's home is north from here."
        [/message]

        [allow_undo][/allow_undo]
    [/event]

    #####################################################################################################
    #####################################################################################################
    ### Home_Section
    ###
    ### Contains code for the fighting around Grog's home.
    ###
    ### home = over and including the river.
    #####################################################################################################
    #####################################################################################################

    #
    # Sighted side 3: start the 2d dwarf and bats recruiting
    #
    [event]
        name=sighted,moveto

        [filter]
            side=3
            [filter_vision]
                viewing_side=1
            [/filter_vision]
        [/filter]

        {CAPTURE_VILLAGES 3 51 11 10}

        [allow_recruit]
            side=3
            type=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Guardsman,Dwarvish Scout
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Vampire Bat,Blood Bat
        [/allow_recruit]

        [kill]
            #side=2,5
            side=2
        [/kill]

        [message]
            speaker=unit
            message=_ "Who goes there?"
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=unit
            message=_ "Intruders! Alert the others!"
        [/message]

        [message]
            speaker=Elyssa
            message=_ "Well, it appears that this is your home, Grog."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _"Clear Grog's home of enemies by killing all the Dwarves and Bats."
                condition=win
            [/objective]
            [objective]
                description= _"Death of Grog"
                condition=lose
            [/objective]
            [objective]
                description= _"Death of Elyssa"
                condition=lose
            [/objective]
            [objective]
                description= _"Time runs out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    ##################################
    # Home_Section >> Troll Villages #
    ##################################

    #
    #macro for getting our trolls out of the villages
#define TROLL_VILLAGE X Y
    [event]
        name=moveto

        [filter]
            side=1
            x={X}
            y={Y}
        [/filter]

        [set_variable]
            name=troll_villages_captured
            add=1
        [/set_variable]

        [switch]
            variable=troll_villages_captured
            [case]
                value=1

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Troll
                    name=_"Og the Clever"
                    id=Og_the_Clever
                    hitpoints=30
                    experience=11
                    side=1
                    random_traits=yes
                    placement=map_passable
                [/unit]

                [message]
                    speaker=Og_the_Clever
                    message=_ "Dun kill me."
                [/message]

                [message]
                    speaker=Grog
                    message=_ "Up Troll. Dun cower like Human!"
                [/message]

                [message]
                    speaker=Elyssa
                    # this is underlined because Elyssa is a bit offended by the phrase above... E_H
                    message=_ "<u>Excuse me?</u>"
                [/message]

                [allow_recruit]
                    side=1
                    type=Troll Whelp
                [/allow_recruit]

                [message]
                    speaker=narrator
                    message= _ "You can now recruit Trolls."
                    image=wesnoth-icon.png
                [/message]
            [/case]

            [case]
                value=2

                [if]
                    [not]
                        [have_unit]
                            id=Zurg
                        [/have_unit]
                    [/not]

                    [then]
                        {ZURG "Troll Shaman TSoG" ($unit.x) ($unit.y)}

                        [+unit]
                            experience=45
                        [/unit]

                        [message]
                            speaker=Elyssa
                            message=_ "Zurg! I thought you had surely perished during the attack."
                        [/message]

                        [message]
                            speaker=Zurg
                            message=_ "Elyssa! You returned! Is that Grog? Returning after many years..."
                        [/message]

                        [message]
                            speaker=Grog
                            message=_ "Zurg! Mage! No talk now. Dwarves to smash!"
                        [/message]

                        [message]
                            speaker=narrator
                            message= _ "For the course of this campaign <i>Troll Shamans</i> are capable of casting both fire and cold spells, and can upgrade to <b>Troll Warbanners</b>."
                            image=wesnoth-icon.png
                        [/message]

                        [objectives]
                            side=1
                            [objective]
                                description= _"Clear Grog's home of enemies by killing all the Dwarves and Bats."
                                condition=win
                            [/objective]
                            [objective]
                                description= _"Death of Grog"
                                condition=lose
                            [/objective]
                            [objective]
                                description= _"Death of Elyssa"
                                condition=lose
                            [/objective]
                            [objective]
                                description= _"Death of Zurg"
                                condition=lose
                            [/objective]
                            [objective]
                                description= _"Time runs out"
                                condition=lose
                            [/objective]
                            [gold_carryover]
                                bonus=yes
                                carryover_percentage=40
                            [/gold_carryover]
                        [/objectives]
                    [/then]

                    [else]
                        [message]
                            speaker=narrator
                            message= _ "Though careful search was made nothing but ashes remained in the ruins."
                            image=wesnoth-icon.png
                        [/message]
                    [/else]
                [/if]
            [/case]

            [case]
                value=3

                [message]
                    speaker=narrator
                    message= _ "Though careful search was made nothing but ashes remained in the ruins."
                    image=wesnoth-icon.png
                [/message]
            [/case]

            [case]
                value=4

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Troll Whelp
                    id=whelp_1
                    experience=16
                    side=1
                    random_traits=yes
                    generate_name=yes
                    placement=map_passable
                [/unit]

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Troll Whelp
                    id=whelp_2
                    experience=23
                    side=1
                    random_traits=yes
                    generate_name=yes
                    placement=map_passable
                [/unit]

                [message]
                    speaker=whelp_1
                    message=_ "Troll hide from stinking Dwarves. Now Trolls smash Dwarves."
                [/message]
            [/case]

            [case]
                value=5

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Dwarvish Steelclad
                    id=village_dwarf
                    experience=16
                    hitpoints=26
                    side=3
                    random_traits=yes
                    generate_name=yes
                    placement=map_passable
                [/unit]

                [message]
                    speaker=village_dwarf
                    message=_ "Can't a fellow sleep without being disturbed? Especially in this Troll ridden pit."
                [/message]

                [message]
                    speaker=village_dwarf
                    message=_ "Eek, you <b><i>are</i></b> Trolls. Help!"
                [/message]

                [if]
                    [variable]
                        name=unit.race
                        equals=troll
                    [/variable]
                    [then]
                        [message]
                            speaker=unit
                            message=_ "You die. Dwarves kill Trolls. Trolls kill Dwarves."
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.id
                                equals=mudcrawler
                            [/variable]
                            [then]
                                [message]
                                    speaker=Elyssa
                                    message=_ "Prepare to meet your fate, Dwarf."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=unit
                                    message=_ "Prepare to meet your fate, Dwarf."
                                [/message]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/case]

            [case]
                value=6

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Troll Rocklobber
                    name=_"Brub the Wise"
                    id=Brub_the_Wise
                    experience=3
                    side=1
                    random_traits=yes
                    placement=map_passable
                [/unit]

                [message]
                    speaker=Brub_the_Wise
                    # wmllint: local spelling Brub
                    message=_ "Brub join too."
                [/message]

                [message]
                    speaker=narrator
                    message= _ "For the course of this campaign <i>Troll Rocklobbers</i> can upgrade to <b>Troll Boulderlobbers</b>."
                    image=wesnoth-icon.png
                [/message]
            [/case]

            [case]
                value=7

                [message]
                    speaker=narrator
                    message= _ "Though careful search was made nothing but ashes remained in the ruins."
                    image=wesnoth-icon.png
                [/message]
            [/case]

            [case]
                value=8

                [message]
                    speaker=narrator
                    message= _ "Though careful search was made nothing but ashes remained in the ruins."
                    image=wesnoth-icon.png
                [/message]
            [/case]

            [case]
                value=9

                [unit]
                    x,y=$unit.x,$unit.y
                    # was {X},{Y}
                    type=Troll Shaman TSoG
                    id=troll_shaman
                    experience=10
                    side=1
                    random_traits=yes
                    generate_name=yes
                    placement=map_passable
                [/unit]

                [message]
                    speaker=troll_shaman
                    message=_ "Let's burn Dwarves."
                [/message]
            [/case]
        [/switch]
    [/event]
#enddef

    {TROLL_VILLAGE 55 16}
    {TROLL_VILLAGE 50 15}
    {TROLL_VILLAGE 45 15}
    {TROLL_VILLAGE 48 11}
    {TROLL_VILLAGE 54 11}
    {TROLL_VILLAGE 53  9}
    {TROLL_VILLAGE 48  8}
    {TROLL_VILLAGE 48  4}
    {TROLL_VILLAGE 53  6}

    #
    # Nasty Naga event
    #
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=33
                y=11
            [/filter_location]
        [/filter]

        [unit]
            #x,y=33,12
            x,y=34,10
            type=Naga Warrior
            id=nasty_naga
            side=5
            random_traits=yes
            generate_name=yes
            placement=map_passable
        [/unit]

        [message]
            speaker=nasty_naga
            message=_ "Hssss. Diesss allsss of youssss." # wmllint: no spellcheck
        [/message]
    [/event]

    #
    # when the Naga dies, he leaves 10 gold, as shadowblack suggested. E_H.
    #
    [event]
        name=last breath
        [filter]
            id=nasty_naga
        [/filter]
        # to avoid giving gold to Dwarves!
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=nasty_naga
            message= _ "Hsss..." # wmllint: no spellcheck
        [/message]
        [if]
            [variable]
                name=second_unit.id
                equals=mudcrawler
            [/variable]
            [then]
                [message]
                    speaker=mudcrawler
                    message= _ "Splarch? Blurble?" # wmllint: no spellcheck
                [/message]
                [message]
                    speaker=Elyssa
                    message= _ "I think that the mudcrawler found something."
                [/message]
            [/then]
            [else]
                [if]
                    [variable]
                        name=second_unit.race
                        equals=troll
                    [/variable]
                    [then]
                        [message]
                            speaker=second_unit
                            message= _ "$second_unit.name found shiny gold."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=second_unit
                            message= _ "It looks like that Naga had some gold with him. Not much, but certainly he can't use it now that he's dead."
                        [/message]
                    [/else]
                [/if]
            [/else]
        [/if]
        [gold]
            side=1
            amount=10
        [/gold]
        [message]
            speaker=narrator
            message= _ "You retrieve 10 gold pieces."
            image=wesnoth-icon.png
            sound=gold.ogg
        [/message]
    [/event]

    #
    # You kill the dwarf in your home: If you havent met Zurg he appears otherwise nothing
    #
    [event]
        name=last breath

        [filter]
            id=dwarfboss2
        [/filter]

        # in case that the player killed him before capturing any village and after killing all bats. E_H.
        [allow_recruit]
            side=1
            type=Troll Whelp
        [/allow_recruit]

        [if]
            [not]
                [have_unit]
                    id=Zurg
                [/have_unit]
            [/not]

            [then]
                {ZURG "Troll Shaman TSoG" 51 11}
                [+unit]
                    experience=45
                [/unit]

                [message]
                    speaker=Elyssa
                    message=_ "Zurg! I thought you had surely perished during the attack."
                [/message]

                [message]
                    speaker=Zurg
                    message=_ "Elyssa! You returned! Is that Grog? Returning after many years..."
                [/message]

                [message]
                    speaker=narrator
                    message= _ "For the course of this campaign <i>Troll Shamans</i> are capable of casting both fire and cold spells, and can upgrade to <b>Troll Warbanners</b>."
                    image=wesnoth-icon.png
                [/message]

                [objectives]
                    side=1
                    [objective]
                        description= _"Clear Grog's home of enemies by killing all the Dwarves and Bats."
                        condition=win
                    [/objective]
                    [objective]
                        description= _"Death of Grog"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _"Death of Elyssa"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _"Death of Zurg"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _"Time runs out"
                        condition=lose
                    [/objective]
                    [gold_carryover]
                        bonus=yes
                        carryover_percentage=40
                    [/gold_carryover]
                [/objectives]
            [/then]
        [/if]
    [/event]

    #
    # You clear Grog's home
    #
    [event]
        name=die

        [filter]
            side=3,4
        [/filter]

        [filter_condition]
            [not]
                [have_unit]
                    side=3,4
                [/have_unit]
            [/not]
        [/filter_condition]

        [kill]
            side=5 # kill all spiders and ants
            animate=no
            fire_event=no
        [/kill]

        [message]
            speaker=Grog
            message=_ "Dwarves all dead. Grog home free!"
        [/message]

        [message]
            speaker=Elyssa
            message=_ "Yes indeed, but why were there so few Dwarves?"
        [/message]

        [message]
            speaker=Zurg
            message=_ "Dwarves gone to war, many Dwarves go south some days back."
        [/message]

        [message]
            speaker=Elyssa
            message=_ "War? With who?"
        [/message]

        [message]
            speaker=Zurg
            message=_ "Dun ask Zurg. Dwarves tell prisoners nothing!"
        [/message]

        [message]
            speaker=Elyssa
            message=_ "Ok, well, what do we do now? Surely the Dwarves will return at some point."
        [/message]

        [message]
            speaker=Zurg
            message=_ "We go stomp Dwarves. Many tunnels in south that Dwarf dun know. Other Trolls may hide there."
        [/message]

        [message]
            speaker=Elyssa
            message=_ "Grog, you are the leader, what do you think is best?"
        [/message]

        [message]
            speaker=Grog
            message=_ "Grog say we go south."
        [/message]

        # Grog must go at 41,30 because moving him at 41,31 KILLS him! E_H.
        [move_unit]
            id=Grog
            to_x=41
            to_y=30
        [/move_unit]
        [move_unit]
            id=Zurg
            to_x=40
            to_y=30
        [/move_unit]
        [move_unit]
            id=Elyssa
            to_x=42
            to_y=30
        [/move_unit]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    #
    # Victory!
    #
    [event]
        name=victory

        {CLEAR_VARIABLE troll_villages_captured}
        {CLEAR_VARIABLE discovered}
        {CLEAR_VARIABLE bridge_destroyed}
        {CLEAR_VARIABLE met_patrol}
        {CLEAR_VARIABLE gave_home_direction}
    [/event]

    {~add-ons/The_Sojournings_of_Grog/utils/tsog-deaths.cfg}
[/scenario]
