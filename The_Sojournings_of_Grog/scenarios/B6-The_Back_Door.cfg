#textdomain wesnoth-The_Sojournings_of_Grog

#
# This scenario has been heavily modified.
#
# DO NOT MODIFY unless you FULLY understand the code.
# everything done here is DELIBERATE.
#
# This scenario uses the status tag created in B4. 1 for friendly, 2 for unfriendly
# but non-aggresive, and 3 for aggressive. Status 1 the humans are friendly. You have
# 2 routes. A human from B5 comes with you as a guide. Status 2 unfriendly. You either
# help the humans and kill the drakes (who are strengthened) or attack the humans
# going to status 3. If you are on status 3 you have to attack them. Jaash/Zurg only have to
# move to the signpost if status = 1. Objectives change when you sight the humans. An aditional complication
# is introduced by the fact that we allow the human leader to die (but not before we sight him). We use variable
# 'auxilary_operation_completed' to mark whether we have completed the extra op (Stat 1: jaash to signpost,
# Stat 2: kill drakes, Stat 3: kill humans). 'G_passed' shows whether Grog has moved to the
# signpost. 'stored_hero' is used to store either jaash or zurg when they leave.
# Because of the many auxilary ops there is quite a bit of duplication. You only get to move to
# C1 (when we have created it) if Jaash is alive (because zurg takes a ship).
#
##Please note that it is no longer possible to move to status 3, as you cannot attack the humans. Elvish_Hunter

# TODO: add monsters
# TODO: add horseman
# TODO: (:n)ise

# wmllint: recognize woseleader
# wmllint: recognize Grog
# wmllint: recognize gryphonboss
# wmllint: recognize Zurg
# wmllint: recognize serpent

#macro defined here. So, to add C1-Zurg, I'll simply change it. Elvish_Hunter
#define NEXT_LEVEL_C1
    [if]
        [variable]
            name=stored_hero.id
            equals=gryphonboss
        [/variable]
        [then]
            [endlevel]
                bonus=yes
                result=victory
                {NEW_GOLD_CARRYOVER 40}
                next_scenario=C1
            [/endlevel]
        [/then]
        [else]
            [endlevel]
                bonus=yes
                result=victory
                {NEW_GOLD_CARRYOVER 40}
                next_scenario=C1-Zurg
            [/endlevel]
        [/else]
    [/if]
#enddef

[scenario]
    id=B6

    victory_when_enemies_defeated=no

    name =_"The Back Door"
    map_data="{~add-ons/The_Sojournings_of_Grog/maps/B6-The_Back_Door.map}"

    #we leave this as B7 so :n ends the scenario
    next_scenario=B7
    {TURNS 30 28 26}

    {TWO_SUNS_DEFAULT_SCHEDULE}

#ifhave ~add-ons/UMC_Music/_main.cfg
    # wmlscope: start ignoring
    {INTRO_AND_SCENARIO_MUSIC "elvish-theme.ogg" "silvan_sanctuary.ogg"}
    {EXTRA_SCENARIO_MUSIC "journeys_end.ogg"}
    {EXTRA_SCENARIO_MUSIC "traveling_minstrels.ogg"}
    {EXTRA_SCENARIO_MUSIC "wanderer.ogg"}
    {EXTRA_SCENARIO_MUSIC "calm-before-storm.ogg"}
    {EXTRA_SCENARIO_MUSIC "nunc_dimittis.ogg"}
    # wmlscope: stop ignoring
#else
    {INTRO_AND_SCENARIO_MUSIC "elvish-theme.ogg" "silvan_sanctuary.ogg"}
    {EXTRA_SCENARIO_MUSIC "journeys_end.ogg"}
    {EXTRA_SCENARIO_MUSIC "traveling_minstrels.ogg"}
    {EXTRA_SCENARIO_MUSIC "wanderer.ogg"}
    {EXTRA_SCENARIO_MUSIC "nunc_dimittis.ogg"}
#endif

    [story]
        [part]
            story= _"They marched towards the Dragon's lair along a northward road; soon they caught the scent of sea air while seagulls circled overhead."
            background=story/Shore.jpg
        [/part]
    [/story]

#define OBJECTIVES_MOVE_JAASH_TO_SIGNPOST_WITH_GUIDE
    [objectives]
        side=1
        [objective]
            description= _ "Get Grog to the signpost in the north-east"
            condition=win
        [/objective]
        [objective]
            description= _ "Get Jaash to the signpost in the north-west"
            condition=win
        [/objective]
        [objective]
            description= _ "Death of Grog"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Zurg"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Elyssa"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Jaash"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of your guide"
            condition=lose
        [/objective]
        # NOTE: human leader is allowed to die
        [objective]
            description= _ "Time runs out"
            condition=lose
        [/objective]
        [gold_carryover]
            bonus=yes
            carryover_percentage=40
        [/gold_carryover]
    [/objectives]
#enddef

#define OBJECTIVES_MOVE_ZURG_TO_SIGNPOST_WITH_GUIDE
    [objectives]
        side=1
        [objective]
            description= _ "Get Grog to the signpost in the north-east"
            condition=win
        [/objective]
        [objective]
            description= _ "Get Zurg to the signpost in the north-west"
            condition=win
        [/objective]
        [objective]
            description= _ "Death of Grog"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Zurg"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Elyssa"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of your guide"
            condition=lose
        [/objective]
        # NOTE: human leader is allowed to die
        [objective]
            description= _ "Time runs out"
            condition=lose
        [/objective]
        [gold_carryover]
            bonus=yes
            carryover_percentage=40
        [/gold_carryover]
    [/objectives]
#enddef

#define OBJECTIVES_MOVE_JAASH_TO_SIGNPOST_NO_GUIDE
    [objectives]
        side=1
        [objective]
            description= _ "Get Grog to the signpost in the north-east"
            condition=win
        [/objective]
        [objective]
            description= _ "Get Jaash to the signpost in the north-west"
            condition=win
        [/objective]
        [objective]
            description= _ "Death of Grog"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Zurg"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Elyssa"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Jaash"
            condition=lose
        [/objective]
        # NOTE: human leader is allowed to die
        [objective]
            description= _ "Time runs out"
            condition=lose
        [/objective]
        [gold_carryover]
            bonus=yes
            carryover_percentage=40
        [/gold_carryover]
    [/objectives]
#enddef

#define OBJECTIVES_MOVE_ZURG_TO_SIGNPOST_NO_GUIDE
    [objectives]
        side=1
        [objective]
            description= _ "Get Grog to the signpost in the north-east"
            condition=win
        [/objective]
        [objective]
            description= _ "Get Zurg to the signpost in the north-west"
            condition=win
        [/objective]
        [objective]
            description= _ "Death of Grog"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Zurg"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Elyssa"
            condition=lose
        [/objective]
        # NOTE: human leader is allowed to die
        [objective]
            description= _ "Time runs out"
            condition=lose
        [/objective]
        [gold_carryover]
            bonus=yes
            carryover_percentage=40
        [/gold_carryover]
    [/objectives]
#enddef

#define OBJECTIVES_DRAKES_DIE
    [objectives]
        side=1
        [objective]
            description= _ "Defeat the drakes"
            condition=win
        [/objective]
        [objective]
            description= _ "Get Grog to the signpost in the north-east"
            condition=win
        [/objective]
        # NOTE: zurg objective is not here
        [objective]
            description= _ "Death of Grog"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Zurg"
            condition=lose
        [/objective]
        [objective]
            description= _ "Death of Elyssa"
            condition=lose
        [/objective]
        # NOTE: human leader is allowed to die
        [objective]
            description= _ "Time runs out"
            condition=lose
        [/objective]
        [gold_carryover]
            bonus=yes
            carryover_percentage=40
        [/gold_carryover]
    [/objectives]
#enddef

    [side]
        side=1
        controller=human
        team_name=goodies
        user_team_name=_"Goodies"

        {GROG}
        type="Grog Great"

        recruit=Troll Whelp

        fog=yes

        {GOLD 120 100 80}
        {INCOME 10 8 6}

        {TROLL_FLAG}
    [/side]

    [side]
        type=Master Bowman
        id=humanboss
        # wmllint: local spelling Yreddyn
        name=_"Yreddyn"

        canrecruit=yes
        side=2
        team_name=goodies
        user_team_name=_"Goodies"
        shroud=no
        #gave him mainly pierce units
        recruit=Javelineer,Longbowman,Pikeman,Swordsman TSoG,Rogue,Trapper_Peasant

        {INCOME 16 14 12}
        {GOLD 60 50 40}

        fog=yes

        [ai]
            grouping=defensive
            passive_leader=yes

            #avoid entering forest
            [avoid]
                x,y=1-47,11-30
            [/avoid]
        [/ai]

        {FLAG_VARIANT loyalist}

        {GENERIC_UNIT 2 "Javelineer" 2 4} {GUARDIAN}
        {GENERIC_UNIT 2 "Pikeman" 3 6} {GUARDIAN}
        {GENERIC_UNIT 2 "Longbowman" 5 7} {GUARDIAN}
        {GENERIC_UNIT 2 "Shock Trooper" 7 6} {GUARDIAN}
        {GENERIC_UNIT 2 "Duelist" 9 5} {GUARDIAN}
        {GENERIC_UNIT 2 "Javelineer" 8 3} {GUARDIAN}
    [/side]

    [side]
        type=Hurricane Drake
        id=drakeboss
        generate_name=yes

        canrecruit=yes

        #L2s only
        recruit=Drake Warrior,Drake Thrasher,Drake Arbiter,Fire Drake,Drake Flare,Sky Drake,Saurian Oracle,Saurian Soothsayer,Saurian Ambusher
        side=3
        team_name=baddies
        user_team_name=_"Baddies"
        shroud=no

        {INCOME 10 15 20}
        {GOLD 260 300 340}

        {FLAG_VARIANT drake}

        [ai]
            #try and get all round recruitment
            recruitment_ignore_bad_movement=yes
            recruitment_ignore_bad_combat=yes

            #avoid entering forest
            [avoid]
                x,y=1-47,11-30
            [/avoid]
        [/ai]
    [/side]

    [side]
        no_leader=yes
        side=4
        team_name=baddies
        user_team_name=_"Baddies"
        [ai]
            grouping=offensive
            aggression=1.0
            caution=0.0

            #avoid leaving forest plus road
            [avoid]
                x,y=1-47,1-9
            [/avoid]
            [avoid]
                x,y=26-47,9-11
            [/avoid]
        [/ai]

        # here wmlscope complains about mismatched references. So, I am forced to shut it. E_H.
        # wmlscope: start ignoring
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 9  26 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 3  23 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 39 26 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 18 19 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 21 19 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 32 30 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 27 27 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose" 38 18 (_ "Forest Warden")} {GUARDIAN}

        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 31 24 (_ "Forest Warden")} {GUARDIAN}
        #attacks humans
        #{GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 9  12 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 24 26 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 39 15 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 12 16 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 24 21 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 43 25 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Wose Shaman" 8  23 (_ "Forest Warden")} {GUARDIAN}

        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 41 20 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 1  20 (_ "Forest Warden")} {GUARDIAN}
        #attacks humans
        #{GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 12 13 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 14 18 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 23 31 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 33 27 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 38 23 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 47 15 (_ "Forest Warden")} {GUARDIAN}
        {GENERIC_UNIT_WITH_NAME 4 "Elder Wose" 26 23 (_ "Forest Warden")} {GUARDIAN}

        #we don't want him running away
        {NAMED_GENERIC_UNIT 4 "Ancient Wose" 44 16 woseleader (_ "Forest Warden")} {GUARDIAN}
        # wmlscope: stop ignoring
    [/side]

    [side]
        no_leader=yes
        side=5
        team_name=baddies
        user_team_name=_"Baddies"
        [ai]
            grouping=offensive
            aggression=1.0
            caution=0.0
        [/ai]

        #	{GENERIC_UNIT 5 "Yeti" 45 29} {GUARDIAN}
        #	{GENERIC_UNIT 5 "Yeti" 17 14} {GUARDIAN}
        #	{GENERIC_UNIT 5 "Yeti" 32 17} {GUARDIAN}

        {GENERIC_UNIT_WITH_ID 5 "Sea Serpent" 23 2 serpent} {GUARDIAN}
        [+unit]
            profile=portraits/sea-monster.png
        [/unit]
    [/side]

    #
    # Sort out when who can hit who
    # For ease of production the human leader and the drake leader cant die
    # until you sight the humans
    #
    {FORCE_CHANCE_TO_HIT () id=humanboss 0 (
        [variable]
            name=sighted_humans
            not_equals=yes
        [/variable]
    )}

    {FORCE_CHANCE_TO_HIT () id=drakeboss 0 (
        [variable]
            name=sighted_humans
            not_equals=yes
        [/variable]
    )}

    #
    # Prestart: Modify the gold depending on status,
    # set-up certain variables, and place ship images.
    #
    [event]
        name=prestart
        [if]
            [variable]
                name=humans_status
                not_equals=1
            [/variable]
            [then]
                #we will need to do more fighting
#ifdef EASY
                [modify_side]
                    side=1
                    gold=160
                [/modify_side]
#endif
#ifdef NORMAL
                [modify_side]
                    side=1
                    gold=140
                [/modify_side]
#endif
#ifdef HARD
                [modify_side]
                    side=1
                    gold=120
                [/modify_side]
#endif
            [/then]
        [/if]

        {VARIABLE sighted_humans no}
        {VARIABLE isalive_leader yes}
        {VARIABLE auxilary_operation_completed no}
        {VARIABLE G_passed no}

        {PLACE_IMAGE "units/transport/transport-galleon.png~RC(magenta>blue)" 3 3}
        {PLACE_IMAGE "units/transport/galleon.png~RC(magenta>blue)" 2 1}
        {PLACE_IMAGE "units/transport/galleon.png~RC(magenta>blue)" 5 2}
        {PLACE_IMAGE "units/transport/transport-galleon.png~RC(magenta>blue)" 7 3}

        {MAKE_HERO woseleader}
    [/event]

    #
    # Start: Move in heroes, set objectives, create human guide,
    # talk, and show the player where to go.
    #
    [event]
        name=start

        # D E B U G
        #{VARIABLE humans_status 1}
        # D E B U G

        #move in lots of random units
        #{MOVE_UNIT_IN Grog 16 31 16 28}
        [move_unit]
            id=Grog
            to_x,to_y=16,28
        [/move_unit]
        {MOVE_UNIT_IN Zurg 16 31 16 27}
        {MOVE_UNIT_IN Elyssa 16 31 17 28}
        {MOVE_UNIT_IN ogreboss 16 31 15 28}
        {MOVE_UNIT_IN Ormron 16 31 17 29}
        {MOVE_UNIT_IN gryphonboss 16 31 15 29}
        #{MOVE_UNIT_IN mudcrawler 16 31 17 30}
        #{MOVE_UNIT_IN Krunk 16 31 16 29}

        #two talk branches depending on whether we are status 1 or 2,3 (a very tired eros)
        #this is breaking the rule of no duplication but it makes it easier to read.
        [if]
            [variable]
                name=humans_status
                equals=1
            [/variable]

            #STATUS 1
            [then]
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]

                    [then]
                        [remove_unit_overlay]
                            id=gryphonboss
                            image=misc/loyal-icon.png
                        [/remove_unit_overlay]

                        {MAKE_HERO gryphonboss}

                        {OBJECTIVES_MOVE_JAASH_TO_SIGNPOST_WITH_GUIDE}
                    [/then]

                    [else]
                        {OBJECTIVES_MOVE_ZURG_TO_SIGNPOST_WITH_GUIDE}
                    [/else]
                [/if]

                [if]
                    [variable]
                        name=isalive_humanguide
                        equals=yes
                    [/variable]
                    [then]
                        [unit]
                            x,y=16,29
                            type=Ranger_Peasant
                            id=humanguide
                            side=1
                            name=_"Hazdrubal"
                            #canrecruit=yes
                            [modifications]
                                {TRAIT_STRONG}
                                {TRAIT_RESILIENT}
                                {TRAIT_LOYAL}
                                [object]
                                    silent=yes
                                    [effect]
                                        apply_to=image_mod
                                        add=RC(magenta>red)
                                    [/effect]
                                [/object]
                            [/modifications]
                            {IS_HERO}
                        [/unit]
                    [/then]
                    [else]
                        [unit]
                            x,y=16,29
                            type=Highwayman_Peasant
                            id=humanguide
                            side=1
                            random_traits=yes
                            name=_"Hamilcar"
                            #canrecruit=yes
                            [modifications]
                                {TRAIT_STRONG}
                                {TRAIT_RESILIENT}
                                {TRAIT_LOYAL}
                                [object]
                                    silent=yes
                                    [effect]
                                        apply_to=image_mod
                                        add=RC(magenta>red)
                                    [/effect]
                                [/object]
                            [/modifications]
                            {IS_HERO}
                        [/unit]
                    [/else]
                [/if]

                #we now use this variable for a different (though obvious) purpose
                {VARIABLE isalive_humanguide yes}

                #move in human guide
                {MOVE_UNIT_IN humanguide 16 31 16 29}

                [message]
                    #Has Elyssa ever seen the sea? (Eros)
                    speaker=Elyssa
                    message= _ "The open sea is just ahead, we need to find a way to send a message back to the Elves; we need their help."
                [/message]

                [message]
                    speaker=Jaash
                    message= _ "Seeeaaaa." # wmllint: no spellcheck
                [/message]

                [message]
                    speaker=humanguide
                    message= _ "There is a human settlement down in the valley. Perhaps we could hire a ship and send a messenger to Zocthanol."
                [/message]

                #if its jaash we assume he will fly
                #if its zurg we assume he will take ship (Eros)
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=gryphonboss
                            message= _ "I flyyyyyy." # wmllint: no spellcheck
                        [/message]

                        [message]
                            speaker=Grog
                            message= _ "Bird go. Boat slow. Fast Bird go."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Zurg
                            message= _ "Zurg go."
                        [/message]

                        [message]
                            speaker=Grog
                            message= _ "Trolls send Zurg. Little Elves trust Troll. Zurg get ship from Human."
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=humanguide
                    message= _ "Very well. For the rest of us, the Dragon's lair lies to the east."
                [/message]

                [message]
                    speaker=Grog
                    message= _ "Trolls go east to Dragon."
                [/message]

                [message]
                    speaker=humanguide
                    message= _ "It is possible to cut through these woods, though it is said that the guardians of the wood deal harshly with intruders."
                [/message]
            [/then]

            #STATUS 2,3
            [else]
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]

                    [then]
                        [remove_unit_overlay]
                            id=gryphonboss
                            image=misc/loyal-icon.png
                        [/remove_unit_overlay]

                        {MAKE_HERO gryphonboss}

                        {OBJECTIVES_MOVE_JAASH_TO_SIGNPOST_NO_GUIDE}
                    [/then]

                    [else]
                        {OBJECTIVES_MOVE_ZURG_TO_SIGNPOST_NO_GUIDE}
                    [/else]
                [/if]

                [message]
                    #Has Elyssa ever seen the sea? (Eros)
                    speaker=Elyssa
                    message= _ "The open sea is just ahead, we need to find a way to send a message back to the Elves; we need their help."
                [/message]

                [message]
                    speaker=gryphonboss
                    message= _ "Seeeaaaa." # wmllint: no spellcheck
                [/message]

                # TODO: pref have this said by Ormron then any recalled human
                [message]
                    speaker=Elyssa
                    message= _ "I am told that there is a human settlement down in the valley. Perhaps we could send a messenger by ship to Zocthanol."
                [/message]

                #if its jaash we assume he will fly
                #if its zurg we assume he will take ship (Eros)
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=gryphonboss
                            message= _ "I flyyyyyy." # wmllint: no spellcheck
                        [/message]

                        [message]
                            speaker=Grog
                            message= _ "Bird go. Boat slow. Fast Bird go."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Zurg
                            message= _ "Zurg go."
                        [/message]

                        [message]
                            speaker=Grog
                            message= _ "Trolls send Zurg. Little Elves trust Troll. Zurg get ship from Human."
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Elyssa
                    message= _ "We should be careful; they may be as unwelcoming as the others."
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "I believe that the Dragon's lair lies to the east."
                [/message]

                [message]
                    speaker=Grog
                    message= _ "Trolls go east to Dragon."
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "It is possible to cut through these woods, though it is said that the guardians of the wood deal harshly with intruders."
                [/message]
            [/else]
        [/if]

        {CLEAR_FOG 1 4 4 0}

		[if]
			[have_unit]
				id=gryphonboss
			[/have_unit]
			[then]
				[label]
					x,y=4,4
					text= _ "<span color='red'>Move Jaash here</span>"
				[/label]
			[/then]
			[else]
				[label]
					x,y=4,4
					text= _ "<span color='red'>Move Zurg here</span>"
				[/label]
			[/else]
		[/if]

        {HIGHLIGHT_IMAGE 4 4 "scenery/signpost.png" ()}

        {UNCLEAR_FOG}

        {CLEAR_FOG 1 44 10 0}
		
		[label]
			x,y=44,10
			text= _ "<span color='red'>Move Grog here</span>"
		[/label]

        {HIGHLIGHT_IMAGE 44 10 "scenery/signpost.png" ()}

        {UNCLEAR_FOG}
    [/event]

    #
    # Wose Sighted: Lets have talk about trees :-)
    #
    [event]
        name=sighted

        [filter]
            race=wose
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [fire_event]
            name=sighted_wose
            [primary_unit]
                x,y=$unit.x,$unit.y
            [/primary_unit]
            [secondary_unit]
                x,y=$second_unit.x,$second_unit.y
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=moveto

        [filter]
            race=wose
        [/filter]

        [filter_vision]
            viewing_side=1
        [/filter_vision]

        #So, this event is a moveto, but we need a second unit.
        #To create one we use the NEAREST_UNIT macro to find the nearest unit to the wose
        #then we pass it as second unit to the fire_event tag.
        #Finally, after having fired the event, we clear the variable to make
        #this workaround transparent and clean. E_H.

        #{NEAREST_UNIT $unit.x $unit.y 999 side=1 side_1_speaker}

        #this is a custom Lua tag. It replaces the macro above. E_H.
        [nearest_unit]
            starting_x=$unit.x
            starting_y=$unit.y
            variable=side_1_speaker
            [filter]
                side=1
            [/filter]
        [/nearest_unit]

        [fire_event]
            name=sighted_wose
            [primary_unit]
                x,y=$unit.x,$unit.y
            [/primary_unit]
            [secondary_unit]
                x,y=$side_1_speaker.x,$side_1_speaker.y
            [/secondary_unit]
        [/fire_event]

        {CLEAR_VARIABLE side_1_speaker}
    [/event]

    [event]
        name=sighted_wose

        {MESSAGE_FIRST_ENEMY
        ( _ "What do you do here Troll. This is Woses' land.")
        ( _ "What do you do here Ogre. This is Woses' land.")
        ( _ "What do you do here Bird. This is Woses' land.")
        ( _ "What do you do here Human. This is Woses' land.")}

        {MESSAGE_SECOND_UNIT
        ( _ "$second_unit.name not hurt tree. $second_unit.name go to other side.")
        ( _ "I not hurt tree. I go to other side.")
        ( _ "Iiii nooot huuuurt treeee.")
        ( _ "I do not seek to harm the trees. I only seek passage to the other side.")}

        {MESSAGE_FIRST_ENEMY
        ( _ "Trolls may have short memories, but Woses do not. Woses were here before all others; the firstborn of Irdya.")
        ( _ "Ogres may have short memories, but Woses do not. Woses were here before all others; the firstborn of Irdya.")
        ( _ "Gryphons may have short memories, but Woses do not. Woses were here before all others; the firstborn of Irdya.")
        ( _ "Humans may have short memories, but Woses do not. Woses were here before all others; the firstborn of Irdya.")}

        {MESSAGE_FIRST_ENEMY
        ( _ "Woses remember everything. Oh yes, Woses remember how you Trolls followed the Orcs. Tree-shaggers we called them. The Woses remember.")
        ( _ "Woses remember everything. Oh yes, Woses remember how you Ogres felled our trees to build your homes. The Woses remember.")
        ( _ "Woses remember everything. Oh yes, Woses remember how you gryphons came with the Dwarves who sought only to kill, maim and destroy the work of centuries. The Woses remember.")
        ( _ "Woses remember everything. Oh yes, Woses remember how you Humans came with axes to chop down trees for your industries. The Woses remember.")}

        {MESSAGE_SECOND_UNIT
        ( _ "Orc now $second_unit.name enemy.")
        ( _ "I never hurt you.")
        ( _ "Iiii neeveeer huuuurt yoooo.")
        ( _ "I have never hurt you.")}

        {MESSAGE_FIRST_ENEMY
        ( _ "Woses do not care. Your journey ends in the eaves of our forest.")
        ( _ "Woses do not care. Your journey ends in the eaves of our forest.")
        ( _ "Woses do not care. Your journey ends in the eaves of our forest.")
        ( _ "Woses do not care. Your journey ends in the eaves of our forest.")}
    [/event]

    # a bit of talk when Wose leader is killed, as per Eros' request. Elvish_Hunter
    [event]
        name=last breath
        [filter]
            id=woseleader
        [/filter]
        [message]
            speaker=woseleader
            message= _ "My spirit will live on in the trees."
        [/message]
    [/event]

    #
    # Sea Sepent Sighted: Random stuff about monsters
    # Doesnt seem to be working (Eros at 2.13 AM)
    #Fixed. I was forced to use an attack event, and not moveto+filter_vision,
    #due to the need of a second_unit. Elvish_Hunter
    [event]
        name=sighted

        [filter]
            type=Sea Serpent
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [fire_event]
            name=sighted_serpent
            [primary_unit]
                x,y=$unit.x,$unit.y
            [/primary_unit]
            [secondary_unit]
                x,y=$second_unit.x,$second_unit.y
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=moveto

        [filter]
            type=Sea Serpent
        [/filter]

        [filter_vision]
            viewing_side=1
        [/filter_vision]

        #again, as in sighted wose event. E_H.
        #{NEAREST_UNIT $unit.x $unit.y 999 side=1 side_1_speaker}

        #this is a custom Lua tag. It replaces the macro above. E_H.
        [nearest_unit]
            starting_x=$unit.x
            starting_y=$unit.y
            variable=side_1_speaker
            [filter]
                side=1
            [/filter]
        [/nearest_unit]

        [fire_event]
            name=sighted_serpent
            [primary_unit]
                x,y=$unit.x,$unit.y
            [/primary_unit]
            [secondary_unit]
                x,y=$side_1_speaker.x,$side_1_speaker.y
            [/secondary_unit]
        [/fire_event]

        {CLEAR_VARIABLE side_1_speaker}
    [/event]

    [event]
        name=sighted_serpent
        [message]
            speaker=serpent
            #green, bold and large. Exactly like him. E_H.
            message= _ "<span color='green' size='large' weight='bold'>GROOOOAAARRR!!!</span>" # wmllint: no spellcheck
        [/message]
        # Elyssa doesn't panic. Ever. Also, check to avoid mucrawler speaking. E_H.
        [if]
            [variable]
                name=second_unit.id
                equals=Elyssa
            [/variable]
            [or]
                [variable]
                    name=second_unit.id
                    equals=mudcrawler
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=Elyssa
                    message= _ "A sea serpent! I bet it could eat a Troll whole."
                [/message]
            [/then]
            [else]
                {MESSAGE_SECOND_UNIT
                ( _ "$second_unit.name no like dat.")
                ( _ "Sea snake is big! Help!")
                ( _ "Heeeelp.")
                ( _ "What <i>is<i> that? Get me out of here!")}
            [/else]
        [/if]
    [/event]

    #
    # Drakes Sighted: Random stuff about drakes.
    # Assuming we see them first (v unlikely)
    #
    [event]
        name=sighted

        [filter]
            race=drake
            [or]
                race=saurian
            [/or]
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        [filter_condition]
            [variable]
                name=sighted_humans
                equals=no
            [/variable]
        [/filter_condition]

        {MESSAGE_SECOND_UNIT
        ( _ "Flying things here. $second_unit.name hate dem.")
        ( _ "Drakes here. I hate Drakes.")
        ( _ "Iii haaate Draakes.")
        ( _ "The Drakes have come, they can never resist a fight.")}
    [/event]

    #
    # Humans Sighted: This is where we decide (or get told) what action we have to take
    # to the humans. We get a number of options.
    # Status 1: we simply have to move our units to the correct destination
    # Status 2: we help the humans
    #
    [event]
        name=sighted

        [filter]
            race=human
        [/filter]

        [filter_second]
            side=1
        [/filter_second]

        {CLEAR_FOG 1 4 4 10}

        {VARIABLE sighted_humans yes}

        [switch]
            variable=humans_status

            # STATUS 1
            [case]
                value=1

                # The leader cant be dead yet
                [message]
                    speaker=humanboss
                    # wmllint: local spelling reinforcemen
                    message= _ "Reinforcements! Rally to me! Let's send these scaly swamp monsters packing!"
                [/message]

                [message]
                    speaker=humanboss
                    message= _ "Hold up. Aren't you Trolls?"
                [/message]

                [message]
                    speaker=humanguide
                    message= _ "Yes they are. But we have formed an alliance with them to fight the Dragon."
                [/message]

                [message]
                    speaker=humanboss
                    message= _ "Well blow me overboard! An alliance with Trolls? Craziest story I ever heard. Well, if you can vouch for them then we wont get in your way, plenty of Drakes for us all!"
                [/message]

                [message]
                    speaker=Zurg
                    message= _ "Trolls go to kill dragon."
                [/message]

                [message]
                    speaker=humanboss
                    message= _ "A mighty fine quest indeed! Trolls on the warpath! Well hold off these scamps while you go and strike the fatal blow!"
                [/message]

                [modify_side]
                    side=1
                    share_maps=yes
                    share_view=yes
                [/modify_side]

                [modify_side]
                    side=2
                    share_maps=yes
                    share_view=yes
                [/modify_side]

                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]

                    [then]
                        {OBJECTIVES_MOVE_JAASH_TO_SIGNPOST_WITH_GUIDE}
                    [/then]

                    [else]
                        {OBJECTIVES_MOVE_ZURG_TO_SIGNPOST_WITH_GUIDE}
                    [/else]
                [/if]
            [/case]

            #STATUS 2
            [case]
                value=2

                [remove_item]
                    x,y=4,4
                [/remove_item]

                [message]
                    speaker=unit
                    message= _ "Sir, a pack of Trolls are approaching from the south!"
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "The messenger seems to have performed his job <i>admirably</i>!"
                [/message]

                [message]
                    speaker=humanboss
                    message= _ "Halt there! State your intentions or feel steel!"
                [/message]

                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]

                    #JAASH
                    [then]
                        [message]
                            speaker=Grog
                            message= _ "Troll go east to smash Dragon."
                        [/message]

                        [message]
                            speaker=humanboss
                            message= _ "Well blow me overboard! Trolls on the warpath, eh? That's something worth seeing I reckon. Tell you what, between you and me, give me a little demonstration on these here Drakes and I'll not hinder you further, save for a small toll of 60 gold."
                        [/message]
                    [/then]

                    #ZURG
                    [else]
                        # currently the humans always demand toll. Though as an added bonus
                        # for keeping your immensely useful scout alive we could change that. (Eros)

                        [message]
                            speaker=Grog
                            message= _ "Trolls need ship den smash Dragon."
                        [/message]

                        [message]
                            speaker=humanboss
                            message= _ "A mighty quest indeed! Trolls on the warpath, eh? That's something worth seeing I reckon. Tell you what, between you and me, give me a little demonstration on these here Drakes and I'll not hinder you further; well say 60 gold for the ship?"
                        [/message]
                    [/else]
                [/if]

                [store_side]
                    side=1
                    variable=stored_side_1
                [/store_side]

                [if]
                    [variable]
                        name=stored_side_1.gold
                        greater_than_equal_to=60
                    [/variable]
                    [then]
                        [message]
                            speaker=Elyssa
                            message= _ "Here is the gold."
                        [/message]
                        [gold]
                            side=1
                            amount=-60
                        [/gold]
                        [message]
                            speaker=humanboss
                            message= _ "Thank you."
                            sound=gold.ogg
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Elyssa
                            message= _ "I am afraid that we do not have that much gold."
                        [/message]
                        [message]
                            speaker=humanboss
                            message= _ "Very well. Make a damn good show of thrashing these Drakes and I'll accept that in lieu of gold."
                        [/message]
                    [/else]
                [/if]

                [gold]
                    side=3
                    amount=100
                [/gold]

                [modify_side]
                    side=1
                    share_maps=yes
                    share_view=yes
                [/modify_side]

                [modify_side]
                    side=2
                    share_maps=yes
                    share_view=yes
                [/modify_side]

                {OBJECTIVES_DRAKES_DIE}
            [/case]
        [/switch]

        {UNCLEAR_FOG}
    [/event]

    #
    # Drake Leader Die:
    # Status 2: if 'G_passed' end scenario else show some random blathers.
    #
    [event]
        name=last breath

        [filter]
            id=drakeboss
        [/filter]

        [message]
            speaker=drakeboss
            message= _ "Grrruummppphhh." # wmllint: no spellcheck
        [/message]

        [if]
            [variable]
                name=humans_status
                equals=2
            [/variable]
            [then]
                [if]
                    [variable]
                        name=isalive_leader
                        equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=humanboss
                            message= _ "An invigorating battle, a glorious victory! Trolls on the warpath indeed. I'm not one to miss excitement, I think well accompany on your quest to..."
                        [/message]

                        [message]
                            speaker=Elyssa
                            message= _ "Zocthanol."
                        [/message]

                        [message]
                            speaker=humanboss
                            message= _ "Zocthanol... Right. Sounds like a fine place for battle!"
                        [/message]
                    [/then]

                    [else]
                        [role]
                            side=2
                            role=tempboss
                        [/role]

                        [message]
                            role=tempboss
                            message= _ "Victory is ours! Sad though it is that Yreddyn did not live to see it. We shall accompany you to ensure your safe passage to...."
                        [/message]

                        [message]
                            speaker=Elyssa
                            message= _ "Zocthanol."
                        [/message]
                    [/else]
                [/if]

                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=gryphonboss
                            message= _ "Weee neeeed nooo shiiiip. Weee flyyy." # wmllint: no spellcheck
                        [/message]
                    [/then]

                    [else]
                        [message]
                            speaker=Zurg
                            message= _ "I will take a ship."
                        [/message]
                    [/else]
                [/if]

                [if]
                    [variable]
                        name=isalive_leader
                        equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=humanboss
                            message= _ "That we can arrange. I will send a messenger ahead to our allies to inform them of your quest."
                        [/message]

                        [message]
                            speaker=Elyssa
                            message= _ "Thank you."
                        [/message]
                    [/then]

                    [else]
                        [role]
                            side=2
                            role=tempboss
                        [/role]

                        [message]
                            role=tempboss
                            message= _ "That we can arrange. I will send a messenger ahead to our allies to inform them of your quest."
                        [/message]

                        [message]
                            speaker=Elyssa
                            message= _ "Thank you."
                        [/message]
                    [/else]
                [/if]

                [fire_event]
                    name=hero_leaves
                [/fire_event]

                [if]
                    [variable]
                        name=G_passed
                        equals=yes
                    [/variable]
                    [then]
                        {NEXT_LEVEL_C1}
                    [/then]
                    [else]
                        [message]
                            speaker=Grog
                            message= _ "Grog see sign. Grog need get to sign."
                        [/message]

                        {VARIABLE auxilary_operation_completed yes}
                    [/else]
                [/if]
            [/then]
        [/if]

        {VARIABLE isalive_leader no}
    [/event]

    #
    # Human Leader Death:
    # Status 3 and G_passed: End scenario.
    # Else: Show some random blathers.
    #
    [event]
        name=last breath

        [filter]
            id=humanboss
        [/filter]

        #STATUS 1,2
        [message]
            speaker=humanboss
            message= _ "My last battle! Avenge me brothers."
        [/message]

        [message]
            side=2
            message= _ "Farewell Yreddyn, a true warrior."
        [/message]

        {VARIABLE isalive_leader no}
    [/event]

    #
    # Human Guide Death:
    # Can only called when status = 1
    #
    [event]
        name=last breath
        [filter]
            id=humanguide
        [/filter]

        [message]
            speaker=humanguide
            # wmllint: local spelling Ackk
            message= _ "Ackk."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "It's going to be hard to find Zocthanol now."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #
    # Moveto Grog and Signpost: Either ends the scenario or reminds you of your objectives.
    # Always fires.
    #
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            id=Grog
            x,y=44,10
        [/filter]

        {VARIABLE G_passed yes}

        [if]
            [variable]
                name=auxilary_operation_completed
                equals=yes
            [/variable]

            [then]
                [message]
                    speaker=Grog
                    message=_"Trolls go."
                [/message]

                {NEXT_LEVEL_C1}
            [/then]

            [else]
                #STATUS 1
                [if]
                    [variable]
                        name=humans_status
                        equals=1
                    [/variable]
                    [or]
                        [variable]
                            name=sighted_humans
                            not_equals=yes
                        [/variable]
                    [/or]
                    [then]
                        [if]
                            [variable]
                                name=isalive_gryphonboss
                                equals=yes
                            [/variable]
                            [then]
                                [message]
                                    speaker=Grog
                                    message=_"Go Bird."
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=Grog
                                    message=_"Go Zurg."
                                [/message]
                            [/else]
                        [/if]
                    [/then]
                [/if]

                #STATUS 2
                [if]
                    [variable]
                        name=humans_status
                        equals=2
                    [/variable]
                    [then]
                        [message]
                            speaker=Grog
                            message=_"Troll smash Drakes first."
                        [/message]
                    [/then]
                [/if]
            [/else]
        [/if]
    [/event]

    #
    # Moveto Gryphon and Signpost: Store him and (if G_passed) end scenario
    # Fires if status=1
    #
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            id=gryphonboss
            x,y=4,4
        [/filter]

        [if]
            [variable]
                name=humans_status
                equals=1
            [/variable]
            [then]
                [fire_event]
                    name=hero_leaves
                [/fire_event]

                [if]
                    [variable]
                        name=G_passed
                        equals=yes
                    [/variable]
                    [then]
                        {NEXT_LEVEL_C1}
                    [/then]
                    [else]
                        {VARIABLE auxilary_operation_completed yes}
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    #
    # Moveto Zurg and Signpost: Store him and (if G_passed) end scenario
    # Fires if status=1
    #
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            id=Zurg
            x,y=4,4
        [/filter]

        [if]
            [variable]
                name=humans_status
                equals=1
            [/variable]
            [then]
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=no
                    [/variable]
                    [then]
                        [fire_event]
                            name=hero_leaves
                        [/fire_event]

                        [if]
                            [variable]
                                name=G_passed
                                equals=yes
                            [/variable]
                            [then]
                                {NEXT_LEVEL_C1}
                            [/then]
                            [else]
                                {VARIABLE auxilary_operation_completed yes}
                            [/else]
                        [/if]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    #
    # Hero Leaves: The fly (or float) away bit for the hero which is then stored
    #
    [event]
        name=hero_leaves

        [if]
            [variable]
                name=isalive_gryphonboss
                equals=yes
            [/variable]
            [then]
                [message]
                    speaker=gryphonboss
                    message=_"I gooo nooow." # wmllint: no spellcheck
                [/message]

                [message]
                    speaker=Elyssa
                    message=_"Good luck, Jaash!"
                [/message]

                [delay]
                    time=750
                [/delay]

                {FULL_HEAL (id=gryphonboss)}

                [store_unit]
                    variable=stored_hero
                    [filter]
                        id=gryphonboss
                    [/filter]

                    kill=yes
                    animate=no
                [/store_unit]

                #doesnt work if he took the ring of speed
                #but this way should. E_H.
                {VARIABLE ("stored_hero.moves") $stored_hero.max_moves}

                [move_unit_fake]
                    type=$stored_hero.type
                    side=1
                    x=$stored_hero.x+",1"
                    y=$stored_hero.y+",7"
                [/move_unit_fake]
            [/then]

            [else]
                [message]
                    speaker=Zurg
                    message=_"Zurg go now."
                [/message]

                [message]
                    speaker=Elyssa
                    message=_"Good luck, Zurg!"
                [/message]

                [delay]
                    time=750
                [/delay]

                {FULL_HEAL (id=Zurg)}

                [store_unit]
                    variable=stored_hero
                    [filter]
                        id=Zurg
                    [/filter]

                    kill=yes
                    animate=no
                [/store_unit]

                #doesnt work if he took the ring of speed
                #but this way should. E_H.
                {VARIABLE ("stored_hero.moves") $stored_hero.max_moves}

                [move_unit_fake]
                    type=$stored_hero.type
                    side=1
                    x=$stored_hero.x+",7"
                    y=$stored_hero.y+",4"
                [/move_unit_fake]

                [delay]
                    time=750
                [/delay]

                #remove ship
                [remove_item]
                    x,y=7,3
                [/remove_item]

                [move_unit_fake]
                    type=Galleon
                    side=1
                    x=7,1
                    y=3,1
                [/move_unit_fake]

                [hide_unit]
                    x,y=1,1
                [/hide_unit]
            [/else]
        [/if]
    [/event]

    #
    # Gryphon Death: we put it before tsog-deaths.cfg for obvious reasons
    # no test for if he is alive also for obvious reasons (Eros)
    #
    [event]
        name=die
        [filter]
            id=gryphonboss
        [/filter]

        [message]
            speaker=Elyssa
            message=_"We won't be able to contact Kaleh now..."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #
    # Victory: clear up time
    #
    [event]
        name=victory

        {CLEAR_VARIABLE "auxilary_operation_completed"}
        {CLEAR_VARIABLE "G_passed"}
        {CLEAR_VARIABLE "sighted_humans"}
        {CLEAR_VARIABLE "isalive_leader"}
    [/event]

    {~add-ons/The_Sojournings_of_Grog/utils/tsog-deaths.cfg}
[/scenario]
