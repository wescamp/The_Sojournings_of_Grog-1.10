#textdomain wesnoth-tsog

#
# This scenario is a bit tricky (or will be when I have finished coding it).
#
# The long term goal is to move the prisoners from A3 into a separate keep elsewhere.
# You find the white mage Ormron. When you find Oberon if you have humans lying around
# they talk to him. He then takes over control (long term allow him to die in this
# scenario with no adverse effects). If you don't find him he turns up at the end (long
# term don't do this).
#
# Here would be a good time to explain the talk that follows in later scenarios.
# If you lose Ormron the spokesman decide to lead you (assuming they are alive). They think they
# will be accepted by the humans but they are WRONG!!!
#
# The drake leader flies away here (If not killed). He is going to return in later
# scenarios when I code this (and decide where).
#

# wmllint: recognize eye_gaurd
# wmllint: recognize poison_gaurd
# wmllint: recognize spokesman
# wmllint: recognize sidekick

[scenario]
    name=_"Nemesis"

    id=A7
    next_scenario=S2
    {TURNS 45 40 35} # increase? on easy was 45

    {UNDERGROUND}

    map_data="{~add-ons/The_Sojournings_of_Grog/maps/A7-Nemesis.map}"

#ifhave ~add-ons/UMC_Music/_main.cfg
    # wmlscope: start ignoring
    {INTRO_AND_SCENARIO_MUSIC "northerners.ogg" "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}
    {EXTRA_SCENARIO_MUSIC "breaking_the_chains.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}
    {EXTRA_SCENARIO_MUSIC "a3deap_DontFearTheReaper.ogg"}
    {EXTRA_SCENARIO_MUSIC "gameplay06.ogg"}
    # wmlscope: stop ignoring
#else
    {INTRO_AND_SCENARIO_MUSIC "northerners.ogg" "the_dangerous_symphony.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}
    {EXTRA_SCENARIO_MUSIC "breaking_the_chains.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}
#endif

    [story]
        [if]
            [variable]
                name=isalive_gryphonboss
                equals=yes
            [/variable]
            [and]
                [variable]
                    name=isalive_ogreboss
                    equals=yes
                [/variable]
            [/and]
            [then]
                [part]
                    story= _ "Grog's party was now joined by Ogres and Gryphons who had long sought the Liches destruction. They entered the now unguarded tunnel that led to the fortress of Mal-Apophis and set up camp."
                    background=portraits/undead/transparent/lich.png
                [/part]
            [/then]
            [else]
                [if]
                    [variable]
                        name=isalive_gryphonboss
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=isalive_ogreboss
                            equals=no
                        [/variable]
                    [/and]
                    [then]
                        [part]
                            story= _ "Grog's party was now joined by Gryphons who had long sought the Liches destruction. They entered the now unguarded tunnel that led to the fortress of Mal-Apophis and set up camp."
                            background=portraits/undead/transparent/lich.png
                        [/part]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=isalive_gryphonboss
                                equals=no
                            [/variable]
                            [and]
                                [variable]
                                    name=isalive_ogreboss
                                    equals=yes
                                [/variable]
                            [/and]
                            [then]
                                [part]
                                    story= _ "Grog's party was now joined by Ogres who had long sought the Liches destruction. They entered the now unguarded tunnel that led to the fortress of Mal-Apophis and set up camp."
                                    background=portraits/undead/transparent/lich.png
                                [/part]
                            [/then]
                            [else]
                                #if we are at this point, both Jaash and I-gruk are dead, so no check. E_H.
                                [part]
                                    story= _ "They entered the now unguarded tunnel that led to the fortress of Mal-Apophis and set up camp."
                                    background=portraits/undead/transparent/lich.png
                                [/part]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/story]

    [side]
        side=1
        controller=human
        team_name=goodies
        user_team_name= _ "Goodies"

        {GROG}
        type="Grog Great"

        recruit=Troll Whelp

        {GOLD 450 400 350} # 350 was on easy, then 300, then 250
        {INCOME 0 0 0}
        shroud=yes

        {TROLL_FLAG}
    [/side]

    [side]
        type=Draug
        id=U1
        generate_name=yes

        canrecruit=yes
        recruit=Skeleton,Skeleton Archer,Soulless
        side=2
        team_name=baddies
        user_team_name=_"Baddies"

        #gold was 260, decreased at 200 after Daravel's request. E_H.
        {INCOME 8 10 12} #this means he will recruit at least one thing per turn
        {GOLD 200 230 260} #small castle size stops you being swamped

        [ai]
            #I dont know how to make them use the whole recruit list but hopefully this will
            recruitment_ignore_bad_combat=yes
            #removed scout because there is no unit with this usage. Elvish_Hunter
            recruitment_pattern=fighter,fighter,archer
        [/ai]

        {FLAG_VARIANT undead}
    [/side]

    {RECRUIT_UNIT_VARIATIONS 2 "Soulless" "none,drake,troll,wose,saurian,mounted,dwarf,bat,gryphon"}

    [side]
        type=Draug
        id=U2
        generate_name=yes

        canrecruit=yes
        recruit=Skeleton,Skeleton Archer,Soulless
        side=3
        team_name=baddies
        user_team_name=_"Baddies"

        #gold was 260, decreased at 200 after Daravel's request. E_H.
        {INCOME 8 10 12} #this means he will recruit at least one thing per turn
        {GOLD 200 230 260} #small castle size stops you being swamped

        [ai]
            #I dont know how to make them use the whole recruit list but hopefully this will
            recruitment_ignore_bad_combat=yes
            #as for side 2. Elvish_Hunter
            recruitment_pattern=fighter,fighter,archer
        [/ai]

        {FLAG_VARIANT undead}
    [/side]

    {RECRUIT_UNIT_VARIATIONS 3 "Soulless" "none,drake,troll,wose,saurian,mounted,dwarf,bat,gryphon"}

    [side]
        type=Death Knight
        id=U3
        generate_name=yes

        canrecruit=yes
        recruit=Revenant,Bone Shooter,Shadow,Wraith,Ghoul,Bone Knight
        side=4
        team_name=baddies
        user_team_name=_"Baddies"

        [ai]
            recruitment_pattern=scout,fighter,fighter,archer
        [/ai]

        {INCOME 10 12 15}
        {GOLD 300 350 400}

        {FLAG_VARIANT undead}
    [/side]

    # limited recruitment because Ghosts are the perfect Troll killers. E_H.
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Shadow" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Wraith" 2}

    [side]
#ifdef HARD
        type=Dread Bat
#else
        type=Blood Bat
#endif
        id=U4
        generate_name=yes

        canrecruit=yes
#ifdef HARD
        recruit=Blood Bat
#else
        recruit=Vampire Bat
#endif
        side=5
        team_name=baddies
        user_team_name=_"Baddies"
        shroud,fog=yes,yes #I want them to wander around until they see you

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            # otherwise they're too afraid of attacking me
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader yes}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution 0}
        [/ai]

        {INCOME 0 1 2}
        {GOLD 30 50 70}
    [/side]

    [side]
        type=Lich
        id=U5
        generate_name=yes

        canrecruit=yes
        side=6
        team_name=baddies
        user_team_name=_"Baddies"

        #recruit list given at the appropriate moment
        {INCOME 0 2 4}
        {GOLD 100 125 150}

        {FLAG_VARIANT undead}
    [/side]

    [side]
        type=Lich
        id=U6
        generate_name=yes

        canrecruit=yes
        side=7
        team_name=baddies
        user_team_name=_"Baddies"

        #recruit list given at the appropriate moment
        {INCOME 0 2 4}
        {GOLD 100 125 150}

        {FLAG_VARIANT undead}
    [/side]

    [side]
        type=Armageddon Drake
        id=drakeambassador
        name=_"Drake Ambassador"

        canrecruit=yes
        side=8
        team_name=baddies
        user_team_name=_"Baddies"

        #recruit list given at the appropriate moment
        {INCOME 0 2 5}
        {GOLD 200 250 300}

        [ai]
            passive_leader=yes
        [/ai]

        #gaurd for poison
#ifdef EASY
        {NAMED_LOYAL_UNIT 8 "Drake Glider" 48 5 poison_gaurd _"Fire Warden"} {GUARDIAN}
#endif
#ifdef NORMAL
        {NAMED_LOYAL_UNIT 8 "Sky Drake" 48 5 poison_gaurd _"Fire Warden"} {GUARDIAN}
#endif
#ifdef HARD
        {NAMED_LOYAL_UNIT 8 "Hurricane Drake" 48 5 poison_gaurd _"Fire Warden"} {GUARDIAN}
#endif

        #create the drakes as well
        #they are closer because they dont like caves
        #and hence ought to go down the chasms
        {GENERIC_UNIT 8 "Hurricane Drake" 41 32}
        {GENERIC_UNIT 8 "Hurricane Drake" 41 33}
        {GENERIC_UNIT 8 "Hurricane Drake" 37 32}
        {GENERIC_UNIT 8 "Hurricane Drake" 37 33}

        {FLAG_VARIANT drake}
    [/side]

    [side]
        type=Ancient Lich
        id=U7
        name=_"Mal-Apophis"

        canrecruit=yes

        side=9
        team_name=baddies
        user_team_name=_"Baddies"

        #recruit list given at the appropriate moment
        {INCOME 0 2 5}
        {GOLD 200 250 300}

        [ai]
            passive_leader=yes
        [/ai]

        {FLAG_VARIANT undead}

        #surprise shadows
#ifdef EASY
        {NAMED_LOYAL_UNIT 9 "Shadow" 7 6 surprise1 _"Shadow Warden"}
        {NAMED_LOYAL_UNIT 9 "Shadow" 7 7 surprise2 _"Shadow Warden"}
#endif
#ifdef NORMAL
        {NAMED_LOYAL_UNIT 9 "Shadow" 7 6 surprise1 _"Shadow Warden"}
        {NAMED_LOYAL_UNIT 9 "Nightgaunt" 7 7 surprise2 _"Shadow Warden"}
#endif
#ifdef HARD
        {NAMED_LOYAL_UNIT 9 "Nightgaunt" 7 6 surprise1 _"Shadow Warden"}
        {NAMED_LOYAL_UNIT 9 "Nightgaunt" 7 7 surprise2 _"Shadow Warden"}
#endif

        #gaurd for eye of krawg
#ifdef EASY
        {NAMED_LOYAL_UNIT 9 "Ghoul" 6 23 eye_gaurd _"Cave Warden"} {GUARDIAN}
#endif
#ifdef NORMAL
        {NAMED_LOYAL_UNIT 9 "Necrophage" 6 23 eye_gaurd _"Cave Warden"} {GUARDIAN}
#endif
#ifdef HARD
        {NAMED_LOYAL_UNIT 9 "Ghast" 6 23 eye_gaurd _"Cave Warden"} {GUARDIAN}
#endif

        #create the free chocobones and shadows
        {GENERIC_UNIT 9 "Chocobone" 42 29}
        {GENERIC_UNIT 9 "Chocobone" 42 31}
        {GENERIC_UNIT 9 "Chocobone" 36 29}
        {GENERIC_UNIT 9 "Chocobone" 36 31}
        {GENERIC_UNIT 9 "Shadow" 43 33}
        {GENERIC_UNIT 9 "Shadow" 35 33}
    [/side]

    [time_area]
        # runes are placed at 26,15 29,15 30,18 32,16
        x=   25,   26,   27,   28,   29,   30,   29,   30,   31,   31,   32,   33
        y=15-16,14-16,15-16,14-15,14-16,14-15,18-19,17-19,18-19,16-17,15-17,16-17
        {RUNIC}
    [/time_area]

    #initialise everything
    [event]
        name=prestart

        #create castle gaurds
        {NOTRAIT_UNIT 9 Revenant 42 32}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 40 33}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 38 33}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 36 32}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 36 28}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 38 27}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 40 27}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 42 28}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Banebow 39 35}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Banebow 39 26}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 40 23}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 33 27}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 33 34}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 38 37}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 45 34}
        [+unit]
            ai_special=guardian
        [/unit]
        {NOTRAIT_UNIT 9 Revenant 45 27}
        [+unit]
            ai_special=guardian
        [/unit]

        #free white mage
        {PLACE_IMAGE "units/human-magi/white-mage.png~RC(magenta>red)" 10 6}
        {PLACE_IMAGE items/cage.png 10 6}

        #another free shaman. E_H.
        {PLACE_IMAGE "units/trolls/shaman.png~RC(magenta>red)" 17 1}
        {PLACE_IMAGE items/cage.png 17 1}

        #chest where dwarf will be
        {PLACE_IMAGE items/chest.png 32 2}

        #variable settings
        {VARIABLE eye_taken  no}
        {VARIABLE poison_taken no}
        {VARIABLE isalive_drakeambassador yes}

        # objectives
        [objectives]
            side=1
            [objective]
                description= _ "Kill the lich"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Grog"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Zurg"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Elyssa"
                condition=lose
            [/objective]
            [objective]
                description= _ "Time runs out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #initialise everything
    [event]
        name=start

        #step down the bats gold if you have no gryphons
        #they will soon catch up (Eros)
        [if]
            [variable]
                name=isalive_gryphonboss
                equals=no
            [/variable]
            [then]
                [modify_side]
                    side=5
#ifdef EASY
                    gold=15
#endif
#ifdef NORMAL
                    gold=25
#endif
#ifdef HARD
                    gold=35
#endif
                    #income=-2
                [/modify_side]
            [/then]
        [/if]

        [recall]
            id=Elyssa
        [/recall]

        [recall]
            id=Zurg
        [/recall]

        #[recall]
        #	id=mudcrawler
        #[/recall]

        #[recall]
        #	id=Krunk
        #[/recall]

        {RECALL_SPOKESMAN}

        {RECALL_SIDEKICK}

        # as shadowblack suggested, if Ogres and Gryphon survived you get bonus units. E_H.
        [if]
            [variable]
                name=isalive_gryphonboss
                equals=yes
            [/variable]
            [then]
                {GENERIC_UNIT 1 "Young Gryphon" 11 4}
            [/then]
        [/if]

        [if]
            [variable]
                name=isalive_ogreboss
                equals=yes
            [/variable]
            [then]
                {GENERIC_UNIT 1 "Young Ogre" 10 4}
            [/then]
        [/if]

        #placed a signpost, so you can see where Ormron is. Elvish_Hunter
        [item]
            x,y=12,8
            image=scenery/signpost.png
        [/item]

        #make it so you can see the chasm
        [remove_shroud]
            x=7,8,7,6,6,6,8
            y=4,4,5,4,3,3,5
            side=1
        [/remove_shroud]
    [/event]

    # A message that is displayed when the player recruits or selects
    # a Young Ogre or a Young Gryphon for the first time.
    [event]
        name=recruit,select
        [filter]
            side=1
            type=Young Ogre
        [/filter]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "For the course of this campaign <i>Young Ogres</i> can upgrade to <u>Ogres</u> and then to <b>Great Ogres</b>."
        [/message]
    [/event]

    [event]
        name=recruit,select
        [filter]
            side=1
            type=Young Gryphon
        [/filter]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "For the course of this campaign we have level 1 Gryphons, called <i>Young Gryphons</i>, that can advance to mainline <b>Gryphons</b>."
        [/message]
    [/event]

    {OBJ_EYE_OF_KRAWG 5 23}

    #I modified sighted events like this. Elvish_Hunter
    [event]
        name=sighted
        [filter]
            id=eye_gaurd
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {MESSAGE_SECOND_UNIT
        ( _ "What Ghoul do there?")
        ( _ "Why that ghouly heree.")
        ( _ "Wwyyy isss attt ooool eerre?")
        ( _ "I wonder what a ghoul is doing down here?")}
    [/event]

    {OBJ_POISON_POTION 48 5}

    #event for moving on signpost near Ormron's cell. Elvish_Hunter
    [event]
        name=moveto
        [filter]
            x,y=12,8
            side=1
        [/filter]
        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "DANGEROUS MAGE HERE! KEEP CLOSED!"
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            id=poison_gaurd
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {MESSAGE_SECOND_UNIT
        ( _ "$second_unit.name sees stuff to kill. $second_unit.name want to squash it.")
        ( _ "Does I see kill to stuff. I's quickly kill him.")
        ( _ "dooo i see stuuffff too kiiillll.")
        ( _ "Ah look. I see some stuff to kill.")}
    [/event]

    #entry talk
    [event]
        name=start

        [message]
            speaker=Elyssa
            message= _"Now it's time to finally lay that rotting heap of bones to rest."
        [/message]

        [message]
            speaker=Zurg
            message= _ "Why tunnel empty? Zurg thought Bones be everywhere. Lich must fight many enemies, all his Bones gone."
        [/message]

        [message]
            speaker=Grog
            message= _"No question. Troll smash now."
        [/message]

        [message]
            speaker=spokesman
            message= _ "Agreed, time for some revenge."
        [/message]

        #Message suggested by Eros. So the player will suspect that there are some objects around. Elvish_Hunter
        [message]
            speaker=Elyssa
            message= _"We need to search carefully as well. A lich doesn't live a thousand years without collecting a few useful trinkets."
        [/message]

        [if]
            [variable]
                name=isalive_gryphonboss
                equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Zurg
                    #prompt the player
                    message= _ "Birds scout tunnels."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Zurg
                    #prompt the player
                    message= _ "Trolls need watch tunnels."
                [/message]
            [/else]
        [/if]
    [/event]

    #shadow surprise
    [event]
        name=attack

        [filter]
            type=Shadow,Nightgaunt
        [/filter]

        [message]
            speaker=unit
            message= _"Wahhhh!" # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elyssa
            message= _"Be wary of these spirits, they can assail us from across the void."
        [/message]
    [/event]

    #humour about the runes
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x=26,29
                y=15,15
                radius=4
            [/filter_location]
        [/filter]

        [message]
            speaker=Grog
            message= _"Duh. More stupid runes!"
        [/message]

        [message]
            speaker=Elyssa
            message= _"It's a good thing that we don't need them for once!"
        [/message]
    [/event]

    #used for all prisoners
    [event]
        name=skeleton_sighted

        [message]
            speaker=Elyssa
            message= _ "Those Skeletons are guarding something..."
        [/message]
    [/event]

#define SECRET_CHAMBER MOVETO_X MOVETO_Y DOOR_X DOOR_Y GUARD_X GUARD_Y

    {PLACE_IMAGE scenery/dwarven-doors-closed.png {DOOR_X} {DOOR_Y}}

    [event]
        name=moveto

        [filter]
            side=1
            x={MOVETO_X}
            y={MOVETO_Y}
        [/filter]

        [remove_item]
            x={DOOR_X}
            y={DOOR_Y}
        [/remove_item]

        [terrain]
            x={DOOR_X}
            y={DOOR_Y}
            terrain=Uu^Dr
        [/terrain]

        [unit]
            type=Skeleton
            side=9
            name= _ "Skeleton Guard"
            x={GUARD_X}
            y={GUARD_Y}
        [/unit]

        [fire_event]
            name=skeleton_sighted
        [/fire_event]
    [/event]
#enddef

    # friendly dwarf. Do I keep? (Eros)
    # currently gold
    # wmlscope: start ignoring
    {SECRET_CHAMBER (28,29) (3,4) 29 3 31 3}
    # wmlscope: stop ignoring

    [event]
        name=moveto

        [filter]
            side=1
            x=32
            y=2
        [/filter]

        [remove_item]
            x=32
            y=2
        [/remove_item]

        [sound]
            name=gold.ogg
        [/sound]

        {MESSAGE_FIRST_UNIT
        ( _ "Shiny coin.")
        ( _ "Shiny coin.")
        ( _ "Kresssuree.")
        ( _ "Oooh, a chest of gold.")}

        [gold]
            side=1
            amount=67
        [/gold]
    [/event]

    #event for new free shaman. E_H.
    # wmlscope: start ignoring
    {SECRET_CHAMBER (14,15) (2,3) 15 2 16 1}
    # wmlscope: stop ignoring
    [event]
        name=moveto

        [filter]
            side=1
            x=17
            y=1
        [/filter]

        [remove_item]
            x=17
            y=1
        [/remove_item]

        {NAMED_GENERIC_UNIT 1 "Troll Shaman TSoG" 16 1 Gong (_ "Gong")}
    [/event]

    #white mage
    # wmlscope: start ignoring
    {SECRET_CHAMBER (11,12) (9,8) 11 8 11 7}
    # wmlscope: stop ignoring

    #inprisoned white mage

#define ORMRON_TALK
    [if]
        [variable]
            name=human_prisoners_helpful
            equals=yes
        [/variable]

        [then]
            #these recalls make Wesnoth crash. E_H.
            #{RECALL_SPOKESMAN}

            #{RECALL_SIDEKICK}

            [message]
                speaker=Elyssa
                message= _ "Greetings, who do we have the pleasure of freeing?"
            [/message]

            [message]
                speaker=Ormron
                message= _ "I am Ormron, I was leading a scouting party when..."
            [/message]

            [message]
                speaker=Elyssa
                message= _ "I believe we have already freed your fellow scouts!"
            [/message]

            [message]
                speaker=Ormron
                message= _ "You did? That is good fortune indeed. I thought they had surely been cut down as they fled."
            [/message]

            #not having the recalls, the messages are said by Elyssa and Zurg. E_H.
            [if]
                [have_unit]
                    id=spokesman
                [/have_unit]
                [then]
                    [message]
                        speaker=spokesman
                        message= _ "Many of us were, but a few of us were taken prisoner by the Orcs."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Elyssa
                        message= _ "Many of them were, but a few of them were taken prisoner by the Orcs."
                    [/message]
                [/else]
            [/if]

            [if]
                [have_unit]
                    id=spokesman
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            id=spokesman
                        [/filter]
                        variable=temp_spokesman
                    [/store_unit]
                    [message]
                        speaker=Ormron
                        message= _ "Well, I am glad you have rescued me; who are your companions? Trolls? Lot's of them! $temp_spokesman.name, you do know..."
                    [/message]
                    {CLEAR_VARIABLE temp_spokesman}
                    [message]
                        speaker=spokesman
                        message= _ "Yes, Trolls. They helped us escape and defeat the Orcs, in return we are to aid them in finding a new home."
                    [/message]
                    [message]
                        speaker=Ormron
                        message= _ "But..."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Ormron
                        message= _ "Well, I am glad you have rescued me; who are your companions? Trolls? Lot's of them!"
                    [/message]
                    [message]
                        speaker=Elyssa
                        message= _ "Yes, Trolls. We helped your companions escape and defeat the Orcs, in return they are to aid Trolls in finding a new home."
                    [/message]
                    [message]
                        speaker=Ormron
                        message= _ "But..."
                    [/message]
                [/else]
            [/if]
        [/then]

        [else]
            [message]
                speaker=Elyssa
                message= _ "Welcome stranger."
            [/message]

            [message]
                speaker=Ormron
                message= _ "Indeed. I was on a scouting party with a group of fellow humans when..."
            [/message]

            [message]
                speaker=Elyssa
                message= _ "We know. We found your friends working for some orcs. They followed us and died fighting in our cause."
            [/message]

            [message]
                speaker=Ormron
                message= _ "You did! I am mighty glad to hear that they died fighting as men rather than being cut down as they fled."
            [/message]

            [message]
                speaker=Ormron
                message= _ "If you don't mind I will follow you - for the time being anyway - and try to redeem the honor of our country."
            [/message]
        [/else]
    [/if]
#enddef

    [event]
        name=moveto

        [filter]
            side=1
            x=10
            y=6
        [/filter]

        [remove_item]
            x=10
            y=6
        [/remove_item]

        [unit]
            type=White Mage
            side=1
            id=Ormron
            # this is an in joke (Eros)
            name= _ "Ormron"
            experience=26
            hitpoints=21
            x=11
            y=7
            [modifications]
                {TRAIT_FEARLESS}
                {TRAIT_RESILIENT}
                {TRAIT_LOYAL}
                [object]
                    silent=yes
                    [effect]
                        apply_to=image_mod
                        add=RC(magenta>red)
                    [/effect]
#ifndef HARD
                    #gived 1 more MP to help the player keeping Ormron alive.
                    #not used the quick trait to avoid HP penalty. Elvish_Hunter
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
#endif
                [/object]
            [/modifications]
            {IS_LOYAL}
        [/unit]

        {VARIABLE isalive_Ormron yes}

        {ORMRON_TALK}

        [message]
            speaker=Grog
            message= _ "Less talk. Bones to squash."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Squash? You mean fry!"
        [/message]
    [/event]

    #used for all prisoners
    [event]
        name=prisoner_released

        [if]
            [variable]
                name=unit.race
                equals=troll
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "Long time in cage! Thanks. Now I go smash again."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "They kept me for a long time in this cage! Thanks. Now I'll go and destroy them."
                [/message]
            [/else]
        [/if]
    [/event]

#define A3_RELEASE MOVETO_X MOVETO_Y DOOR_X DOOR_Y GUARD_X GUARD_Y PRISON_X PRISON_Y ID
    [event]
        name=start

        [if]
            [variable] #if there is a stored unit, length of that array will be more than 0
                name={ID}.length
                greater_than=0
            [/variable]

            [then]
                #{PLACE_IMAGE units/unknown-unit.png {PRISON_X} {PRISON_Y}}
                #This shows the unit sprite in cage. E_H.
                {PLACE_IMAGE ${ID}.image {PRISON_X} {PRISON_Y}}
                {PLACE_IMAGE items/cage.png {PRISON_X} {PRISON_Y}}
                {PLACE_IMAGE scenery/dwarven-doors-closed.png {DOOR_X} {DOOR_Y}}

                [event]
                    name=moveto

                    [filter]
                        side=1
                        x={MOVETO_X}
                        y={MOVETO_Y}
                    [/filter]

                    [remove_item]
                        x={DOOR_X}
                        y={DOOR_Y}
                    [/remove_item]

                    [terrain]
                        x={DOOR_X}
                        y={DOOR_Y}
                        terrain=Uu^Dr
                    [/terrain]

                    [unit]
                        type=Skeleton
                        side=9
                        name= _ "Skeleton Guard"
                        x={GUARD_X}
                        y={GUARD_Y}
                    [/unit]

                    [fire_event]
                        name=skeleton_sighted
                    [/fire_event]
                [/event]

                [event]
                    name=moveto

                    [filter]
                        side=1
                        x={PRISON_X}
                        y={PRISON_Y}
                    [/filter]

                    [remove_item]
                        x={PRISON_X}
                        y={PRISON_Y}
                    [/remove_item]

                    #this saves on work by using guard position
                    {VARIABLE {ID}.x {GUARD_X}}
                    {VARIABLE {ID}.y {GUARD_Y}}
                    #this is to fullheal prisoners. Elvish_Hunter
                    {VARIABLE {ID}.hitpoints ${ID}.max_hitpoints}

                    [unstore_unit]
                        variable={ID}
                        find_vacant=yes
                    [/unstore_unit]

                    #workaround to have a message said by the prisoner. E_H.
                    [fire_event]
                        name=prisoner_released
                        [primary_unit]
                            id=${ID}.id
                        [/primary_unit]
                    [/fire_event]

                    {CLEAR_VARIABLE {ID}}
                [/event]
            [/then]
        [/if]
    [/event]
#enddef

    #five ones for captures in A3
    #currently disabled (Eros)
    # wmlscope: start ignoring
    {A3_RELEASE (22,22) (13,14) 21 14 19 25 19 16 stored_bodyguard_1}
    {A3_RELEASE (15,16) (26,26) 15 27 13 27 12 27 stored_bodyguard_2}
    {A3_RELEASE (19)    (30)    19 31 18 32 16 33 stored_bodyguard_3}
    {A3_RELEASE (51,52) (38,37) 52 38 53 39 53 40 stored_bodyguard_4}
    {A3_RELEASE (36)    (8)     35 8  35 6  34 5  stored_bodyguard_5}
    # wmlscope: stop ignoring

    #start the lich and drake and two friends recruiting when you move into the start space
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x=30-50
                y=20-50
            [/filter_location]
        [/filter]

        [allow_recruit]
            side=6
            type=Blood Bat,Wraith,Ghost
        [/allow_recruit]

        [allow_recruit]
            side=7
            type=Blood Bat,Wraith,Ghost
        [/allow_recruit]

        [allow_recruit]
            side=8
            type=Drake Warrior,Drake Thrasher,Drake Arbiter,Fire Drake,Drake Flare,Sky Drake
        [/allow_recruit]

        [allow_recruit]
            side=9
            type=Dread Bat,Revenant,Bone Shooter,Necrophage,Deathblade,Chocobone,Bone Knight,Death Baron
        [/allow_recruit]
    [/event]

    #warn the player that the drake ought to be killed
    [event]
        name=sighted
        [filter]
            id=drakeambassador
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Elyssa
            #REGECT: he is hardly creepy is he! (Eros)
            #message= _ "Hey its that creepy ambassador again."
            message= _ "Hey, it's that lovely Drake ambassador. I think we should kill him this time."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            id=U7
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Elyssa
            message= _ "You are trapped, fiend!"
        [/message]

        [message]
            speaker=U7
            message= _ "Ahaha, trapped? No, I'm not trapped! Prepare to die!"
        [/message]
    [/event]

    #inform player about smaug
    [event]
        name=last breath
        [filter]
            id=drakeambassador
        [/filter]

        [message]
            speaker=drakeambassador
            message=_"You can not kill an ambassador of his Majesty Akhenku the Great."
        [/message]

        [floating_text]
            x,y=$unit.x,$unit.y
            text= _ "<span foreground='yellow'>*swish*</span>"
        [/floating_text]

        [message]
            speaker=drakeambassador
            message=_"I, I die. You will pay for this."
        [/message]

        [message]
            speaker=Elyssa
            message=_"Who might Akhenku be?"
        [/message]

        [message]
            speaker=U7
            message=_"Akhenku. I am sure you will enjoy meeting <i>him.</i>"
        [/message]

        {VARIABLE isalive_drakeambassador no}
    [/event]

    [event] # messages fired in the wrong moment. Correct.
        name=attack

        [filter]
            side=1
        [/filter]

        [filter_second]
            id=U7
        [/filter_second]

        [message]
            speaker=Elyssa
            message= _ "Burn and never return!"
        [/message]

        [message]
            speaker=Zurg
            message= _ "Fist and fire, kill this thing!"
            #stolen off of UtBS (Mars)
            #Imitation is the sincerest form of flatery (Eros)
        [/message]
    [/event]

    #lich dies
    [event]
        name=die
        [filter]
            id=U7
        [/filter]

        #some flashes to make his death more impressive. E_H.
        [delay]
            time=2000
        [/delay]
        [sound]
            name=dragonstick.ogg
        [/sound]
        [flash_screen]
            color=red
        [/flash_screen]
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=2000
        [/delay]
        [flash_screen]
            color=yellow
        [/flash_screen]
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=2000
        [/delay]
        [flash_screen]
            color=green
        [/flash_screen]
        [sound]
            name=lightning.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=2000
        [/delay]
        [flash_screen]
            color=blue
        [/flash_screen]
        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        {QUAKE rumble.ogg}
        [delay]
            time=2000
        [/delay]
        [flash_screen]
            color=white
        [/flash_screen]
        [sound]
            name=lich-die.ogg
        [/sound]

        [message]
            speaker=narrator
            message=_"The Lich's ancient bones began to crumble under the ferocious blows. It turned it's rotting head upwards and emitted a piercing cry that rebounded off the walls, the hearts of all those who heard it were tainted; sullied by the dying cry of the Lich."
            image=wesnoth-icon.png
        [/message]

        #incase they didnt kill the drake (fools!) EROS
        [if]
            [have_unit]
                id=drakeambassador
            [/have_unit]

            [then]
                [message]
                    speaker=drakeambassador
                    message= _ "You puny creatures will suffer eternally for this. You dare slay an ally of the Great Akhenku?"
                [/message]

                [message]
                    speaker=Elyssa
                    message= _ "Who might Akhenku be?"
                [/message]

                [message]
                    speaker=drakeambassador
                    message= _ "Akhenku. I am sure you will enjoy meeting <i>him.</i>"
                [/message]

                [kill]
                    id=drakeambassador
                    animate=no
                    fire_event=no
                [/kill]

                [move_unit_fake]
                    type=Armageddon Drake
                    side=8
                    x=39,27
                    y=32,40
                [/move_unit_fake]
            [/then]

            [else]
                [message]
                    speaker=Elyssa
                    message= _ "I am glad we finished of the drake. All his talk about 'Akhenku' gave me the creeps."
                [/message]
            [/else]
        [/if]

        # TODO: at this point we could make you go and search for him which might be more interesting
        [if]
            [variable]
                name=isalive_Ormron
                equals=not_found
            [/variable]

            [then]
                [move_unit_fake]
                    type=White Mage
                    side=1
                    x=27,32
                    y=40,37
                [/move_unit_fake]

                [unit]
                    type=White Mage
                    side=1
                    id=Ormron
                    # this is an in joke (Eros)
                    name= _ "Ormron"
                    experience=26
                    x=32
                    y=37
                    [modifications]
                        {TRAIT_FEARLESS}
                        {TRAIT_RESILIENT}
                        {TRAIT_LOYAL}
                        [object]
                            silent=yes
                            [effect]
                                apply_to=image_mod
                                add=RC(magenta>red)
                            [/effect]
#ifndef HARD
                            #gived 1 more MP to help the player keeping Ormron alive.
                            #not used the quick trait to avoid HP penalty. Elvish_Hunter
                            [effect]
                                apply_to=movement
                                increase=1
                            [/effect]
#endif
                        [/object]
                    [/modifications]
                    {IS_LOYAL}
                [/unit]

                {VARIABLE isalive_Ormron yes}

                {ORMRON_TALK}
            [/then]
        [/if]

        {CLEAR_VARIABLE "poison_taken"}
        {CLEAR_VARIABLE "eye_taken"}

        #store unit required for talk in S2. Elvish_Hunter
        [store_unit]
            variable=spokesman_unit
            kill=no
            [filter]
                id=spokesman
            [/filter]
        [/store_unit]

        [store_unit]
            variable=sidekick_unit
            kill=no
            [filter]
                id=sidekick
            [/filter]
        [/store_unit]

        #just in case that Ormron is already Mage of Light
        [store_unit]
            variable=stored_Ormron
            kill=no
            [filter]
                id=Ormron
            [/filter]
        [/store_unit]

        [store_unit]
            variable=stored_E
            kill=no
            animate=no
            [filter]
                id=Elyssa
            [/filter]
        [/store_unit]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    [event]
        name=time over
        [message]
            speaker=Elyssa
            message= _ "The orcs have returned and are cutting of our retreat. We are doomed."
        [/message]
    [/event]

    {~add-ons/The_Sojournings_of_Grog/utils/tsog-deaths.cfg}
[/scenario]
